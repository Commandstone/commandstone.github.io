<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é«˜çº§ç‹¼äººæ€æ¸¸æˆ</title>
    <style>
        /* ç•Œé¢æ ·å¼ä¼˜åŒ– */
        .container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            min-height: 100vh;
        }
        #playerPanel {
            border: 2px solid #2d2d2d;
            padding: 15px;
            border-radius: 8px;
        }
        .player-card {
            background: #333;
            margin: 10px;
            padding: 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        .player-card:hover {
            background: #444;
        }
        #gameLog {
            background: #222;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="playerPanel"></div>
        <div id="controlPanel">
            <h3>æ¸¸æˆé˜¶æ®µï¼š<span id="phaseDisplay">å‡†å¤‡ä¸­</span></h3>
            <div id="actionButtons"></div>
            <div id="gameLog"></div>
        </div>
    </div>

    <script>
        // ================= æ¸¸æˆæ ¸å¿ƒç±»å®šä¹‰ =================
        class Game {
            constructor() {
                this.players = [];
                this.phase = 'night'; // night/day
                this.currentStage = 'wolf'; // wolf/witch/prophet
                this.killedTonight = [];
                this.gameLog = [];
                this.initRoles();
            }

            initRoles() {
                const roles = [
                    { role: 'ç‹¼äºº', camp: 'wolf', count: 2 },
                    { role: 'é¢„è¨€å®¶', camp: 'human', count: 1 },
                    { role: 'å¥³å·«', camp: 'human', count: 1 },
                    { role: 'çŒäºº', camp: 'human', count: 1 },
                    { role: 'å¹³æ°‘', camp: 'human', count: 4 }
                ];
                
                roles.forEach(r => {
                    for (let i = 0; i < r.count; i++) {
                        this.players.push({
                            id: this.players.length + 1,
                            role: r.role,
                            camp: r.camp,
                            alive: true,
                            poisoned: false,
                            protected: false
                        });
                    }
                });
                this.players = this.shuffleArray(this.players);:ml-citation{ref="2,6" data="citationList"}
            }

            shuffleArray(arr) {
                return arr.sort(() => Math.random() - 0.5);
            }

            // ================= å¤œæ™šé˜¶æ®µé€»è¾‘ =================
            wolfAction(targetId) {
                const target = this.players.find(p => p.id === targetId);
                if (target.protected) {
                    this.addLog(`å®ˆå«ä¿æŠ¤äº† ${targetId} å·ç©å®¶`);
                    return;
                }
                this.killedTonight.push(targetId);
                this.addLog(`ç‹¼äººé€‰æ‹©å‡»æ€ ${targetId} å·ç©å®¶`);:ml-citation{ref="3,7" data="citationList"}
            }

            witchAction(type, targetId = null) {
                const witch = this.players.find(p => p.role === 'å¥³å·«');
                if (type === 'antidote') {
                    witch.antidote = false;
                    this.killedTonight = [];
                    this.addLog(`å¥³å·«ä½¿ç”¨è§£è¯æ•‘æ´»äº† ${targetId} å·`);
                } else if (type === 'poison') {
                    witch.poison = false;
                    this.players.find(p => p.id === targetId).alive = false;
                    this.addLog(`å¥³å·«æ¯’æ€äº† ${targetId} å·ç©å®¶`);:ml-citation{ref="5,7" data="citationList"}
                }
            }

            prophetAction(targetId) {
                const target = this.players.find(p => p.id === targetId);
                this.addLog(`${targetId} å·ç©å®¶å±äº ${target.camp} é˜µè¥`);:ml-citation{ref="6,7" data="citationList"}
            }

            // ================= ç™½å¤©é˜¶æ®µé€»è¾‘ =================
            startVoting() {
                this.phase = 'day';
                this.addLog("å¼€å§‹æŠ•ç¥¨ç¯èŠ‚");
                this.renderPlayers();
            }

            processVotes() {
                const votes = {};
                this.players.forEach(p => {
                    if (p.alive && p.voteTarget) {
                        votes[p.voteTarget] = (votes[p.voteTarget] || 0) + 1;
                    }
                });
                const maxVotes = Math.max(...Object.values(votes));
                const targets = Object.keys(votes).filter(k => votes[k] === maxVotes);
                
                targets.forEach(t => {
                    const player = this.players.find(p => p.id == t);
                    player.alive = false;
                    this.addLog(`${t} å·ç©å®¶è¢«æŠ•ç¥¨å¤„å†³`);
                    if (player.role === 'çŒäºº') this.hunterAction(t);:ml-citation{ref="3,7" data="citationList"}
                });
            }

            hunterAction(targetId) {
                const hunter = this.players.find(p => p.id == targetId);
                if (hunter.alive) return;
                this.addLog("çŒäººå‘åŠ¨æŠ€èƒ½ï¼Œè¯·é€‰æ‹©å¸¦èµ°çš„ç©å®¶");
                // éœ€å®ç°ç©å®¶é€‰æ‹©é€»è¾‘:ml-citation{ref="7" data="citationList"}
            }

            // ================= è¾…åŠ©æ–¹æ³• =================
            addLog(text) {
                this.gameLog.push(`[${new Date().toLocaleTimeString()}] ${text}`);
                this.renderLog();
            }

            checkGameEnd() {
                const wolves = this.players.filter(p => p.camp === 'wolf' && p.alive);
                const humans = this.players.filter(p => p.camp === 'human' && p.alive);
                if (wolves.length === 0) return 'human';
                if (wolves.length >= humans.length) return 'wolf';
                return null;
            }
        }

        // ================= ç•Œé¢æ¸²æŸ“ä¸äº¤äº’ =================
        const game = new Game();
        
        function renderPlayers() {
            const container = document.getElementById('playerPanel');
            container.innerHTML = game.players.map(p => `
                <div class="player-card" data-id="${p.id}" 
                     onclick="handlePlayerClick(${p.id})"
                     style="opacity: ${p.alive ? 1 : 0.4}">
                    <span>ç©å®¶ ${p.id}</span>
                    <span>${p.alive ? 'å­˜æ´»' : 'æ­»äº¡'}</span>
                    ${p.poisoned ? 'ğŸ’€' : ''}
                </div>
            `).join('');:ml-citation{ref="8" data="citationList"}
        }

        function updateControlPanel() {
            document.getElementById('phaseDisplay').textContent = 
                game.phase === 'night' ? 'å¤œæ™š' : 'ç™½å¤©';
            
            const btnPanel = document.getElementById('actionButtons');
            if (game.phase === 'night') {
                let buttons = '';
                if (game.currentStage === 'wolf') {
                    buttons = '<button onclick="nextStage()">ç‹¼äººè¡ŒåŠ¨å®Œæˆ</button>';
                } else if (game.currentStage === 'witch') {
                    buttons = `
                        <button onclick="useAntidote()">ä½¿ç”¨è§£è¯</button>
                        <button onclick="usePoison()">ä½¿ç”¨æ¯’è¯</button>
                    `;
                }
                btnPanel.innerHTML = buttons;:ml-citation{ref="7,8" data="citationList"}
            } else {
                btnPanel.innerHTML = '<button onclick="startVoting()">å¼€å§‹æŠ•ç¥¨</button>';
            }
        }

        // ================= äº‹ä»¶å¤„ç† =================
        function handlePlayerClick(playerId) {
            if (game.phase === 'night') {
                if (game.currentStage === 'wolf') game.wolfAction(playerId);
                else if (game.currentStage === 'prophet') game.prophetAction(playerId);
            } else {
                const player = game.players.find(p => p.id === playerId);
                if (player.alive) player.voteTarget = playerId;
            }
            renderPlayers();:ml-citation{ref="6,8" data="citationList"}
        }

        function nextStage() {
            const stages = ['wolf', 'witch', 'prophet'];
            const index = stages.indexOf(game.currentStage);
            game.currentStage = stages[index + 1] || 'day';
            updateControlPanel();:ml-citation{ref="7" data="citationList"}
        }

        // ================= åˆå§‹åŒ– =================
        renderPlayers();
        updateControlPanel();
    </script>
</body>
</html>
