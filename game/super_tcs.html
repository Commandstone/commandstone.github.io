<!DOCTYPE html>
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title _msttexthash="16819946" _msthash="0">贪吃蛇游戏</title>
    <script src="./super_tcs_files/saved_resource"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyBYEJtxpjkUL7QW8M-Vbe0_fSC6KqijfTE",
            authDomain: "echoweave-j9ji8.firebaseapp.com",
            projectId: "echoweave-j9ji8",
            storageBucket: "echoweave-j9ji8.firebasestorage.app",
            messagingSenderId: "732629009205",
            appId: "1:732629009205:web:0289b1db1d24ec16c1c27c"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Firebase instances (Canvas environment specific)
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        // Use __app_id from environment for Firestore paths, if available
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Use __initial_auth_token from environment for initial authentication, if available
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    </script>

    <style>
        /* Global styles to prevent overall page scrolling */
        html, body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
            font-family: "Inter", sans-serif;
            background-color: #1a202c; /* bg-gray-900 */
        }

        /* Custom animations */
        @keyframes slide-in-snake {
            0% { left: -100%; }
            100% { left: calc(50% - 50px); } /* Center the 100px wide snake */
        }
        @keyframes fade-out-light {
            0% { opacity: 0; transform: scale(0.1); }
            50% { opacity: 1; transform: scale(1.5); }
            100% { opacity: 0; transform: scale(2); }
        }
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 1; }
            50% { transform: scale(1.0); opacity: 0.7; }
            100% { transform: scale(0.8); opacity: 1; }
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInFromTop {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Achievement Notification - Google Play Style (Adjusted for larger size and font) */
        .achievement-notification-container {
            position: fixed;
            top: 20px; /* Position at the top */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            pointer-events: none; /* Allow clicks to pass through */
        }

        .achievement-notification {
            background: linear-gradient(90deg, #ffe066 0%, #ffd700 100%);
            color: #3a2c00;
            border-radius: 50px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.18);
            min-height: 80px; /* 加大通知高度 */
            width: 60px; /* Initial width for circle animation */
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
            font-family: "Noto Sans TC", "Arial", sans-serif;
            animation: expandNotification 1s cubic-bezier(.62,1.17,.84,1) forwards;
            opacity: 0; /* Start hidden for pop-in animation */
        }

        /* Keyframes for Achievement Notification */
        @keyframes popCircle {
            0% { width: 38px; height: 38px; opacity: 0; }
            70% { width: 60px; height: 60px; opacity: 1; }
            100% { width: 60px; height: 60px; opacity: 1; }
        }
        @keyframes expandNotification {
            0% {
                width: 60px;
                border-radius: 50%;
                padding: 0;
                opacity: 0; /* Added for initial pop-in */
            }
            60% {
                width: 60px;
                border-radius: 50%;
                padding: 0;
                opacity: 1;
            }
            100% {
                width: 480px; /* 加大通知框寬度 */
                border-radius: 50px;
                padding: 0 40px 0 100px; /* 調整內距 */
                opacity: 1;
            }
        }
        @keyframes fadeOutNotification { /* Added for fading out after a delay */
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        .trophy-icon-circle {
            width: 60px; /* 加大圖標圓圈大小 */
            height: 60px;
            background: #fff8d0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 0;
            top: 50%; /* Center vertically */
            transform: translateY(-50%); /* Center vertically */
            z-index: 2;
            opacity: 0;
            animation: popCircle 0.5s cubic-bezier(.62,1.17,.84,1) forwards;
            box-shadow: 0 4px 12px rgba(0,0,0,0.13);
        }
        .trophy-icon-svg {
            width: 45px; /* 加大SVG圖標大小 */
            height: 45px;
            fill: #ffd700;
            stroke: #b49d2d;
            stroke-width: 1.2px;
            z-index: 3;
        }
        .notification-content {
            opacity: 0;
            margin-left: 70px; /* 調整左邊距以適應更大的獎盃圖標 */
            transition: opacity 0.3s 0.7s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex-grow: 1; /* Allow content to take available space */
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis */
        }
        .achievement-notification.expanded .notification-content {
            opacity: 1;
        }
        .achievement-name {
            font-size: 18px; /* 加大成就名稱字體 */
            font-weight: bold;
            margin-bottom: 2px;
            color: #3a2c00;
        }
        .achievement-rewards {
            font-size: 14px; /* 加大分数和金币字體 */
            color: #7c6f36;
        }
        /* Confetti (existing styles, might need minor adjustments for new size) */
        .confetti {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 3;
            overflow: hidden;
        }
        .confetti-piece {
            position: absolute;
            width: 4px; /* Smaller confetti */
            height: 8px;
            border-radius: 1px;
            opacity: 0.85;
            animation: confetti-fall 1.8s cubic-bezier(.22,.68,.43,.99) forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-10px) rotateZ(0deg); opacity: 0.85; } /* Smaller initial translateY */
            90% { opacity: 1; }
            100% { transform: translateY(50px) rotateZ(360deg); opacity: 0; } /* Smaller final translateY */
        }


        /* Level Up Notification */
        .level-up-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(147, 51, 234, 0.9); /* purple-600 with transparency */
            color: white;
            padding: 30px 60px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            z-index: 1001;
            opacity: 0; /* Start hidden */
            animation: levelUpGrowFadeIn 0.5s ease-out forwards;
        }

        .level-up-notification.fade-out {
            animation: levelUpShrinkFadeOut 0.5s ease-in forwards;
        }

        .level-up-notification span {
            display: inline-block;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .level-up-notification .old-level {
            opacity: 1;
        }
        .level-up-notification .new-level {
            opacity: 0;
            transform: translateY(20px);
        }
        .level-up-notification.show-new .old-level {
            opacity: 0;
            transform: translateY(-20px);
        }
        .level-up-notification.show-new .new-level {
            opacity: 1;
            transform: translateY(0);
        }

        /* Utility classes for animations */
        .animate-pulse { animation: pulse 1.5s infinite; }
        .animate-fade-in { animation: fadeIn 1s ease-out forwards; }
        .animate-fade-in-out { animation: fadeInOut 2s ease-in-out forwards; }

        /* Specific styles for the intro animation elements */
        .intro-snake {
            animation: slide-in-snake 2s forwards;
        }
        .intro-light {
            animation: fade-out-light 1s forwards;
        }

        /* For scrollable shop and achievements content */
        .scrollable-content-container {
            flex-grow: 1; /* Allows it to take available vertical space */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
            width: 100%; /* Ensure it takes full width */
            padding-bottom: 1rem; /* Add some padding at the bottom for scrolling */
        }

        /* Joystick styles */
        .joystick-base {
            width: 120px;
            height: 120px;
            background-color: rgba(55, 65, 81, 0.7); /* gray-700 with transparency */
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            touch-action: none; /* Prevent default touch actions like scrolling */
        }

        .joystick-stick {
            width: 60px;
            height: 60px;
            background-color: rgba(107, 114, 128, 0.9); /* gray-500 with transparency */
            border-radius: 50%;
            position: absolute;
            transform: translate(0, 0); /* Initial position */
            transition: transform 0.05s ease-out; /* Smooth movement for the stick */
        }

        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #2d3748; /* gray-800 */
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            color: white;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #4a5568;
            padding: 10px;
            border-radius: 8px;
            background-color: #1a202c;
        }
        .emoji-item {
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .emoji-item:hover {
            background-color: #4a5568;
        }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.16 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0px}.left-4{left:1rem}.right-4{right:1rem}.top-4{top:1rem}.mb-2{margin-bottom:0.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-1{margin-top:0.25rem}.mt-8{margin-top:2rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-full{height:100%}.h-3{height:0.75rem}.h-24{height:6rem}.min-h-screen{min-height:100vh}.w-full{width:100%}.w-32{width:8rem}.w-64{width:16rem}.w-24{width:6rem}.max-w-md{max-width:28rem}.max-w-2xl{max-width:42rem}.max-w-4xl{max-width:56rem}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}@keyframes bounce{0%, 100%{transform:translateY(-25%);animation-timing-function:cubic-bezier(0.8,0,1,1)}50%{transform:none;animation-timing-function:cubic-bezier(0,0,0.2,1)}}.animate-bounce{animation:bounce 1s infinite}.cursor-pointer{cursor:pointer}.cursor-not-allowed{cursor:not-allowed}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-x-4 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem * var(--tw-space-x-reverse));margin-left:calc(1rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-2 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.5rem * var(--tw-space-x-reverse));margin-left:calc(0.5rem * calc(1 - var(--tw-space-x-reverse)))}.overflow-hidden{overflow:hidden}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.rounded-md{border-radius:0.375rem}.rounded-sm{border-radius:0.125rem}.border{border-width:1px}.border-2{border-width:2px}.border-4{border-width:4px}.border-gray-600{--tw-border-opacity:1;border-color:rgb(75 85 99 / var(--tw-border-opacity, 1))}.border-gray-700{--tw-border-opacity:1;border-color:rgb(55 65 81 / var(--tw-border-opacity, 1))}.bg-gray-900{--tw-bg-opacity:1;background-color:rgb(17 24 39 / var(--tw-bg-opacity, 1))}.bg-gray-700{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity, 1))}.bg-gray-800{--tw-bg-opacity:1;background-color:rgb(31 41 55 / var(--tw-bg-opacity, 1))}.bg-indigo-600{--tw-bg-opacity:1;background-color:rgb(79 70 229 / var(--tw-bg-opacity, 1))}.bg-gray-600{--tw-bg-opacity:1;background-color:rgb(75 85 99 / var(--tw-bg-opacity, 1))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74 / var(--tw-bg-opacity, 1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246 / var(--tw-bg-opacity, 1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.bg-yellow-600{--tw-bg-opacity:1;background-color:rgb(202 138 4 / var(--tw-bg-opacity, 1))}.bg-purple-600{--tw-bg-opacity:1;background-color:rgb(147 51 234 / var(--tw-bg-opacity, 1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-yellow-400{--tw-bg-opacity:1;background-color:rgb(250 204 21 / var(--tw-bg-opacity, 1))}.bg-blue-700{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity, 1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94 / var(--tw-bg-opacity, 1))}.bg-opacity-60{--tw-bg-opacity:0.6}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-8{padding:2rem}.p-2{padding:0.5rem}.p-6{padding:1.5rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-4{padding-top:1rem;padding-bottom:1rem}.text-center{text-align:center}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-5xl{font-size:3rem;line-height:1}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-xs{font-size:0.75rem;line-height:1rem}.text-6xl{font-size:3.75rem;line-height:1}.text-2xl{font-size:1.5rem;line-height:2rem}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-blue-400{--tw-text-opacity:1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}.text-green-400{--tw-text-opacity:1;color:rgb(74 222 128 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-yellow-400{--tw-text-opacity:1;color:rgb(250 204 21 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.text-black{--tw-text-opacity:1;color:rgb(0 0 0 / var(--tw-text-opacity, 1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68 / var(--tw-text-opacity, 1))}.opacity-0{opacity:0}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.drop-shadow-lg{--tw-drop-shadow:drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.transition{transition-property:color, background-color, border-color, fill, stroke, opacity, box-shadow, transform, filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.hover\:scale-105:hover{--tw-scale-x:1.05;--tw-scale-y:1.05;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:border-blue-500:hover{--tw-border-opacity:1;border-color:rgb(59 130 246 / var(--tw-border-opacity, 1))}.hover\:bg-indigo-700:hover{--tw-bg-opacity:1;background-color:rgb(67 56 202 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-700:hover{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity, 1))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61 / var(--tw-bg-opacity, 1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity, 1))}.hover\:bg-yellow-700:hover{--tw-bg-opacity:1;background-color:rgb(161 98 7 / var(--tw-bg-opacity, 1))}.hover\:bg-purple-700:hover{--tw-bg-opacity:1;background-color:rgb(126 34 206 / var(--tw-bg-opacity, 1))}.hover\:bg-blue-600:hover{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.hover\:underline:hover{-webkit-text-decoration-line:underline;text-decoration-line:underline}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-blue-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246 / var(--tw-ring-opacity, 1))}.group:hover .group-hover\:opacity-100{opacity:1}@media (min-width: 768px){.md\:hidden{display:none}.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}}@media (min-width: 1024px){.lg\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}}</style><style id="panai-style">
                .panai-container { z-index: 99999!important }
                .panai-popup { font-size: 14px !important }
                .panai-setting-label { display: flex;align-items: center;justify-content: space-between;padding-top: 20px; }
                .panai-setting-checkbox { width: 16px;height: 16px; }
            </style></head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen">

    <div id="app-root" class="w-full h-full flex items-center justify-center" _msthidden="2">
                    <div class="relative flex flex-col items-center justify-center h-full w-full">
                        <h1 class="text-5xl font-extrabold text-white mb-8 drop-shadow-lg animate-bounce" _msttexthash="9562137" _msthash="303">贪吃蛇</h1>
                        <button id="start-game-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mb-4" _msttexthash="11168430" _msthash="304"> 开始游戏 </button>
                        <button id="shop-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mb-4" _msttexthash="4504890" _msthash="305">
                            商店
                        </button>
                        <button id="achievements-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105" _msttexthash="4738968" _msthash="306">
                            成就
                        </button>
                        <div class="absolute top-4 left-4 text-white text-xl flex items-center">
                            <button id="profile-menu-btn" class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-700 transition-colors">
                                <span class="text-4xl" _msttexthash="10948015" _msthash="307">😀</span>
                                <div class="flex flex-col items-start">
                                    <span _msttexthash="61984" _msthash="308">Guest</span>
                                    <span _msttexthash="13891215" _msthash="309">等级： 1</span>
                                    <div class="relative w-32 h-3 bg-gray-700 rounded-full mt-1 overflow-hidden group">
                                        <div class="absolute h-full bg-blue-500 rounded-full" style="width: 8%;"></div>
                                        <div class="absolute inset-0 flex items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity duration-300" _msttexthash="76037" _msthash="310">
                                            80 / 1000 XP
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        <div class="absolute top-4 right-4 text-white text-xl">
                            <span _msttexthash="13553865" _msthash="311">金币： 20</span>
                        </div>
                    </div>
                </div>

    <div id="achievement-notification-container" class="achievement-notification-container" _msthidden="3"></div>
    <div id="level-up-notification-container"></div>
    <div id="modal-container"></div>

    <script type="module">
        // Import Firebase modules from global scope
        const app = window.firebaseApp;
        const auth = window.firebaseAuth;
        const db = window.firebaseDb;
        const appId = window.appId;
        const initialAuthToken = window.initialAuthToken;

        import { signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // Game constants
        const GRID_SIZE_BASE = 20; // Base size of each cell in pixels, will be scaled
        const BOARD_WIDTH_CELLS = 25;
        const BOARD_HEIGHT_CELLS = 25;
        const INITIAL_SPEED = 200; // Milliseconds per move (higher value = slower)
        const COIN_PER_FOOD = 1;
        const NUM_INITIAL_FOODS = 2; // Number of food items at start
        const XP_PER_LEVEL = 1000; // XP required for each level
        const SCORE_TO_XP_MULTIPLIER = 10; // 1 score point = 10 XP


        // Difficulty settings
        const difficulties = [
            { id: 'easy', name: '简单', speed: 200, price: 0, default: true },
            { id: 'medium', name: '中等', speed: 150, price: 100 },
            { id: 'hard', name: '困难', speed: 100, price: 200 },
        ];

        // Map data
        const maps = [
            {
                id: 'grassland',
                name: '草原',
                price: 0,
                default: true,
                backgroundColor: '#8BC34A', // Green-500
                obstacleColor: '#558B2F',
                obstacles: [], // No obstacles for grassland
            },
            {
                id: 'forest',
                name: '森林',
                price: 150,
                backgroundColor: '#4CAF50', // Green-600
                obstacleColor: '#388E3C', // Darker green
                obstacles: [
                    // Example obstacles for forest
                    { x: 5, y: 5 }, { x: 5, y: 6 }, { x: 5, y: 7 },
                    { x: 14, y: 14 }, { x: 14, y: 13 }, { x: 14, y: 12 },
                    { x: 10, y: 2 }, { x: 11, y: 2 },
                    { x: 2, y: 10 }, { x: 2, y: 11 },
                    { x: 17, y: 8 }, { x: 17, y: 9 },
                ],
            },
            {
                id: 'desert',
                name: '沙漠',
                price: 250,
                backgroundColor: '#FFCC80', // Orange-200
                obstacleColor: '#D2691E', // Chocolate
                obstacles: [
                    // Example obstacles for desert
                    { x: 0, y: 0 }, { x: 1, y: 0 }, { x: 0, y: 1 }, // Corners
                    { x: BOARD_WIDTH_CELLS - 1, y: 0 }, { x: BOARD_WIDTH_CELLS - 2, y: 0 }, { x: BOARD_WIDTH_CELLS - 1, y: 1 },
                    { x: 0, y: BOARD_HEIGHT_CELLS - 1 }, { x: 1, y: BOARD_HEIGHT_CELLS - 1 }, { x: 0, y: BOARD_HEIGHT_CELLS - 2 },
                    { x: BOARD_WIDTH_CELLS - 1, y: BOARD_HEIGHT_CELLS - 1 }, { x: BOARD_WIDTH_CELLS - 2, y: BOARD_HEIGHT_CELLS - 1 }, { x: BOARD_WIDTH_CELLS - 1, y: BOARD_HEIGHT_CELLS - 2 },
                    { x: 7, y: 7 }, { x: 8, y: 8 }, { x: 9, y: 7 }, // Scattered
                    { x: 12, y: 12 }, { x: 11, y: 13 }, { x: 13, y: 11 },
                ],
            },
        ];

        // Shop items data (skins and power-ups)
        const shopItemsData = [
            { id: 'skin_blue', type: 'skin', name: '蓝色蛇皮', price: 0, color: '#3B82F6', default: true, category: 'skins', skill: '无技能', skillEffect: null },
            { id: 'skin_red', type: 'skin', name: '红色蛇皮', price: 75, color: '#EF4444', category: 'skins', skill: '火焰加速 (游戏速度微幅提升)', skillEffect: { type: 'passive_speed_boost', value: -10 } },
            { id: 'skin_green', type: 'skin', name: '绿色蛇皮', price: 100, color: '#22C55E', category: 'skins', skill: '自然成张 (游戏开始时多一个蛇身)', skillEffect: { type: 'start_grow', value: 1 } },
            { id: 'skin_yellow', type: 'skin', name: '黄色蛇皮', price: 120, color: '#FACC15', category: 'skins', skill: '金币磁鐵 (每次吃食物多一个金币)', skillEffect: { type: 'extra_coin', value: 1 } },
            { id: 'skin_purple', type: 'skin', name: '紫色蛇皮', price: 150, color: '#A78BFA', category: 'skins', skill: '幸運金币 (每次吃食物有20%機率获得额外金币)', skillEffect: { type: 'lucky_coin', chance: 0.2 } },
            { id: 'skin_orange', type: 'skin', name: '橘色蛇皮', price: 130, color: '#FB923C', category: 'skins', skill: '食物感應 (食物會閃爍得更快)', skillEffect: { type: 'food_blink_speed', value: 0.5 } },
            { id: 'skin_cyan', type: 'skin', name: '青色蛇皮', price: 140, color: '#22D3EE', category: 'skins', skill: '輕盈身姿 (每次轉彎時短暫加速)', skillEffect: { type: 'turn_speed_boost', duration: 100, value: -50 } },
            { id: 'skin_pink', type: 'skin', name: '粉色蛇皮', price: 160, color: '#F472B6', category: 'skins', skill: '金币奖励 (游戏结束時额外获得50金币)', skillEffect: { type: 'end_game_bonus_coins', value: 50 } },
            { id: 'skin_brown', type: 'skin', name: '棕色蛇皮', price: 110, color: '#8B5F2A', category: 'skins', skill: '堅韌皮膚 (游戏開始時获得一个護盾，抵擋一次碰撞)', skillEffect: { type: 'start_shield', value: 1 } },
            { id: 'skin_gray', type: 'skin', name: '灰色蛇皮', price: 90, color: '#9CA3AF', category: 'skins', skill: '低調潛行 (游戏開始時金币增加50)', skillEffect: { type: 'start_bonus_coins', value: 50 } },
            { id: 'skin_white', type: 'skin', name: '白色蛇皮', price: 180, color: '#F3F4F6', category: 'skins', skill: '光速反應 (每次吃食物後短暫无敌)', skillEffect: { type: 'food_invincibility', duration: 500 } },
            { id: 'powerup_speed', type: 'powerup', name: '速度提升 (5秒)', price: 30, effect: 'speed', duration: 5000, category: 'powerups' },
            { id: 'powerup_grow', type: 'powerup', name: '立即成长', price: 20, effect: 'grow', category: 'powerups' },
            // New Power-ups
            { id: 'powerup_clear_obstacles', type: 'powerup', name: '清除障碍', price: 80, effect: 'clear_obstacles', category: 'powerups' },
            { id: 'powerup_slow_motion', type: 'powerup', name: '慢动作 (5秒)', price: 60, effect: 'slow_motion', duration: 5000, category: 'powerups' },
            { id: 'powerup_double_score', type: 'powerup', name: '二倍分数 (10秒)', price: 100, effect: 'double_score', duration: 10000, category: 'powerups' },
            { id: 'powerup_teleport', type: 'powerup', name: '瞬间移动', price: 70, effect: 'teleport', category: 'powerups' },
            { id: 'powerup_extra_life', type: 'powerup', name: '额外生命', price: 150, effect: 'extra_life', value: 1, category: 'powerups' },
            { id: 'powerup_multi_food', type: 'powerup', name: '多重食物', price: 90, effect: 'multi_food', count: 3, category: 'powerups' },
            { id: 'powerup_ghost_mode', type: 'powerup', name: '幽灵模式 (3秒)', price: 120, effect: 'ghost_mode', duration: 3000, category: 'powerups' },
            { id: 'powerup_shrink_snake', type: 'powerup', name: '缩小蛇身', price: 50, effect: 'shrink_snake', value: 3, category: 'powerups' },
            { id: 'powerup_coin_boost', type: 'powerup', name: '金币加速 (7秒)', price: 110, effect: 'coin_boost', duration: 7000, value: 2, category: 'powerups' }, // Added value for multiplier
            { id: 'powerup_super_food', type: 'powerup', name: '超级食物', price: 130, effect: 'super_food', score_bonus: 5, coin_bonus: 5, category: 'powerups' },
        ];

        // Game state variables
        let currentPage = 'auth'; // Start with authentication page
        let score = 0;
        let coins = 0;
        let lastGameCoins = 0;
        let xp = 0; // New: Experience points
        let level = 1; // New: Player level
        let snake = [{ x: 10, y: 10 }];
        let foods = [];
        let direction = { x: 0, y: -1 };
        let isGameOver = false;
        let gameSpeed = INITIAL_SPEED;
        let activeSkinId = 'skin_blue';
        let selectedDifficultyId = 'easy';
        let selectedMapId = 'grassland';
        let purchasedItems = {};
        let message = null;
        let powerupActive = null;
        let shopCategory = 'skins';
        let achievementCategory = 'progress'; // New: Default achievement category

        // Skin skill related states
        let currentShield = 0;
        let invincibilityActive = false;
        let foodBlinkSpeed = 1.5;

        // Power-up related states
        let isDoubleScoreActive = false;
        let doubleScoreTimer = null;
        let extraLives = 0;
        let isGhostModeActive = false;
        let ghostModeTimer = null;
        let isCoinBoostActive = false;
        let coinBoostTimer = null;
        let isSuperFoodActive = false;
        let superFoodBonus = { score: 0, coins: 0 };
        let currentMapObstacles = [];
        let powerupsUsedThisGame = false; // Flag for no-powerup achievements

        // Achievement related states
        let gameStats = {}; // Will be initialized in loadState()
        let completedAchievements = {}; // { achievementId: true }
        let unlockedExclusiveRewards = {}; // { rewardId: true }
        let currentAchievementNotification = null; // For displaying one notification at a time

        // Timers and refs
        let gameInterval = null;
        let lastDirection = { x: 0, y: -1 };
        let invincibilityTimer = null;
        let turnSpeedBoostTimer = null;
        let messageTimer = null;
        let achievementNotificationTimer = null;
        let levelUpNotificationTimer = null; // New: For level up animation

        // Joystick related variables
        let joystickBase = null;
        let joystickStick = null;
        let joystickActive = false;
        let joystickCenterX = 0;
        let joystickCenterY = 0;
        const joystickRadius = 60;

        // User authentication and profile
        let currentUserId = null;
        let isGuestUser = false;
        let userProfile = {
            displayName: 'Guest',
            avatar: '😀',
            level: 1,
            xp: 0
        };
        let selectedAvatar = '😀'; // For avatar selection during registration/guest setup

        // DOM elements
        const appRoot = document.getElementById('app-root');
        const achievementNotificationContainer = document.getElementById('achievement-notification-container');
        const levelUpNotificationContainer = document.getElementById('level-up-notification-container');
        const modalContainer = document.getElementById('modal-container');

        // Emojis for avatar selection
        const emojis = [
            '😀', '😁', '😂', '🤣', '😃', '😄', '😅', '😆', '😉', '😊', '😋', '😎', '🤩', '😏', '😮', '🤔', '🤐', '🤨', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥', '😌', '😔', '😪', '🤤', '😴', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '😇', '🤠', '🥳', '🥰', '😘', '😗', '😙', '😚', '🙂', '🙃', '😛', '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫', ' düşün', '🤐', '🤨', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥', '😌', '😔', '😪', '🤤', '😴', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '😇', '🤠', '🥳', '🥰', '😘', '😗', '😙', '😚', '🙂', '🙃', '😛', '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫', '🤔', '🤐', '🤨', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥', '😌', '😔', '😪', '🤤', '😴', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '😇', '🤠', '🥳', '🥰', '😘', '😗', '😙', '😚', '🙂', '🙃', '😛', '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫'
        ];


        // --- Exclusive Rewards (not in shopItemsData initially) ---
        const exclusiveRewards = {
            exclusive_skin_golden: { id: 'exclusive_skin_golden', type: 'skin', name: '黃金蛇皮', color: '#FFD700', skill: '金光闪闪 (额外金币奖励)', skillEffect: { type: 'extra_coin', value: 2 } },
            exclusive_skill_coin_frenzy: { id: 'exclusive_skill_coin_frenzy', type: 'powerup', name: '金币狂热 (10秒)', effect: 'coin_frenzy', duration: 10000, category: 'exclusive_skills', skill: '金币狂热 (所有金币三倍)' },
            exclusive_skin_rainbow: { id: 'exclusive_skin_rainbow', type: 'skin', name: '彩虹蛇皮', color: 'linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet)', skill: '道具增强 (所有道具持续时间+1秒)', skillEffect: { type: 'powerup_duration_boost', value: 1000 } },
            exclusive_skill_map_reveal: { id: 'exclusive_skill_map_reveal', type: 'powerup', name: '地图透视 (5秒)', effect: 'map_reveal', duration: 5000, category: 'exclusive_skills', skill: '地图透视 (暫時顯示所有障碍物和食物)' },
            exclusive_skin_diamond: { id: 'exclusive_skin_diamond', type: 'skin', name: '钻石蛇皮', color: '#B9F2FF', skill: '堅不可摧 (游戏開始時获得额外護盾)', skillEffect: { type: 'start_shield', value: 2 } },
            exclusive_skill_skin_synergy: { id: 'exclusive_skill_skin_synergy', type: 'skill', name: '技能協同', skill: '技能協同 (游戏開始時获得奖励一个已擁有皮膚的被動技能)', skillEffect: { type: 'random_passive_skill_at_start' } },
            exclusive_skin_ghostly: { id: 'exclusive_skin_ghostly', type: 'skin', name: '幽灵蛇皮', color: '#E0E7FF', skill: '幽灵附體 (碰撞後有機會短暫進入幽灵模式)', skillEffect: { type: 'ghost_on_hit', chance: 0.5, duration: 1000 } },
        };

        // --- Achievement Categories ---
        const achievementCategories = [
            {
                id: 'progress', name: '游戏难度',
                achievements: ['first_food', 'ten_food', 'century_food', 'foods_eaten_300', 'foods_eaten_750', 'foods_eaten_2000', 'foods_eaten_5000', 'first_game', 'ten_games', 'games_played_30', 'games_played_50', 'games_played_75', 'hundred_games', 'two_hundred_games', 'total_games_500'],
                exclusiveReward: exclusiveRewards.exclusive_skin_golden
            },
            {
                id: 'coin_master', name: '金币大师',
                achievements: ['first_coin', 'hundred_coins', 'total_coins_200', 'total_coins_300', 'thousand_coins', 'total_coins_1500', 'two_thousand_coins', 'five_thousand_coins', 'total_coins_10000', 'max_coins_in_game_50', 'max_coins_in_game_75', 'max_coins_in_game_100', 'max_coins_in_game_150', 'max_coins_in_game_200', 'total_coins_spent_500', 'total_coins_spent_750', 'total_coins_spent_1000', 'total_coins_spent_1500', 'total_coins_spent_2000', 'total_coins_spent_3000', 'total_coins_spent_5000'],
                exclusiveReward: exclusiveRewards.exclusive_skill_coin_frenzy
            },
            {
                id: 'powerup_expert', name: '道具专家',
                achievements: ['clear_obstacle_one', 'obstacles_cleared_5', 'powerup_first', 'powerup_any_five', 'powerup_any_ten', 'powerup_any_fifteen', 'shield_used', 'shield_used_five', 'extra_life_used', 'extra_life_two', 'teleport_five', 'teleport_ten', 'ghost_mode_three', 'ghost_mode_five', 'shrink_snake_two', 'shrink_snake_five', 'coin_boost_three', 'super_food_three', 'use_all_powerups', 'all_powerups_master'],
                exclusiveReward: exclusiveRewards.exclusive_skin_rainbow
            },
            {
                id: 'map_explorer', name: '地图探索',
                achievements: ['unlock_forest_map', 'unlock_desert_map', 'unlock_all_maps', 'play_grassland_map', 'play_forest_map', 'play_desert_map', 'play_grassland_5', 'play_grassland_10', 'play_forest_3', 'play_forest_5', 'play_desert_3', 'play_desert_5', 'play_all_maps', 'play_all_maps_5_times', 'win_forest', 'win_desert', 'win_all_maps_once', 'win_all_maps_no_powerup', 'win_all_maps_no_powerup_master', 'win_forest_no_obstacle', 'win_forest_no_obstacle_3', 'win_desert_no_obstacle', 'win_desert_no_obstacle_3'],
                exclusiveReward: exclusiveRewards.exclusive_skill_map_reveal
            },
            {
                id: 'difficulty_challenge', name: '难度挑战',
                achievements: ['unlock_medium_diff', 'unlock_hard_diff', 'unlock_all_difficulties', 'play_easy_5_times', 'play_easy_10_times', 'play_medium_5_times', 'play_medium_10_times', 'play_hard_5_times', 'play_hard_10_times', 'play_all_difficulties', 'play_all_difficulties_5_times', 'win_easy', 'win_easy_5', 'win_easy_10', 'win_medium', 'win_medium_3', 'win_medium_5', 'win_hard', 'win_hard_2', 'win_hard_3', 'win_all_difficulties', 'win_easy_no_powerup', 'win_easy_no_powerup_3', 'win_medium_no_powerup', 'win_medium_no_powerup_3', 'win_hard_no_powerup', 'win_hard_no_powerup_3', 'win_all_difficulties_no_powerup', 'win_all_difficulties_no_powerup_master'],
                exclusiveReward: exclusiveRewards.exclusive_skin_diamond
            },
            {
                id: 'skin_collector', name: '皮毛收藏',
                achievements: ['purchase_skin_one', 'purchase_skin_three', 'purchase_skin_five', 'purchase_skin_eight', 'purchase_skin_nine', 'collect_all_skins', 'items_purchased_5', 'items_purchased_7', 'items_purchased_10', 'items_purchased_15', 'items_purchased_18', 'purchase_items_all', 'collect_all_items', 'played_all_skins', 'use_all_skin_skills', 'all_skins_skills_master'],
                exclusiveReward: exclusiveRewards.exclusive_skill_skin_synergy
            },
            {
                id: 'art_of_dying', name: '死亡',
                achievements: ['die_once', 'die_ten_times', 'total_deaths_50', 'total_deaths_100', 'die_by_self', 'die_by_wall', 'die_by_obstacle', 'died_by_all_types'],
                exclusiveReward: exclusiveRewards.exclusive_skin_ghostly
            },
            {
                id: 'mastery', name: '精通',
                achievements: ['score_50', 'score_100', 'score_200', 'score_500', 'score_1000', 'snake_length_10', 'snake_length_15', 'snake_length_20', 'snake_length_25', 'snake_length_30', 'snake_length_40', 'snake_length_50', 'max_snake_length_75', 'max_snake_length_100', 'eat_5_in_row', 'eat_10_in_row', 'eat_15_in_row', 'eat_20_in_row', 'no_collision_50_score', 'no_collision_100_score', 'total_score_1000', 'total_score_5000', 'total_score_10000', 'total_score_20000', 'total_score_50000', 'total_score_100000', 'lucky_coin_triggered_10', 'lucky_coin_triggered_30', 'turn_speed_boost_20', 'turn_speed_boost_50', 'food_invincibility_5', 'food_invincibility_15', 'score_40_easy', 'score_40_medium', 'score_50_hard', 'score_50_forest', 'score_50_desert', 'score_150_hard_no_powerup', 'score_50_no_powerup', 'snake_length_20_no_powerup', 'snake_length_50_hard_no_powerup', 'win_all_difficulties_no_powerup_all_maps'],
                exclusiveReward: null // No specific reward for this, it's a meta-category
            },
            {
                id: 'grand_master', name: '大师',
                achievements: ['all_achievements_half', 'all_achievements_75_percent', 'all_achievements_90_percent', 'all_achievements_completed'],
                exclusiveReward: null // No specific reward for this, it's a meta-category
            }
        ];


        // --- Achievement Definitions ---
        // Each achievement now has a 'category' property and 'xpReward'
        const allAchievements = [
            // Game Progress
            { id: 'first_food', name: '初来乍到', description: '第一次吃到食物', condition: (stats) => stats.foodsEaten >= 1, reward: 2, xpReward: 10, category: 'progress' },
            { id: 'ten_food', name: '十全十美', description: '吃到10个食物', condition: (stats) => stats.foodsEaten >= 10, reward: 5, xpReward: 20, category: 'progress' },
            { id: 'century_food', name: '百战百胜', description: '吃到100个食物', condition: (stats) => stats.foodsEaten >= 100, reward: 12, xpReward: 50, category: 'progress' },
            { id: 'foods_eaten_300', name: '食物狂人', description: '一共吃到300个食物', condition: (stats) => stats.foodsEaten >= 300, reward: 15, xpReward: 60, category: 'progress' },
            { id: 'foods_eaten_750', name: '食物狂人', description: '一共吃到750个食物', condition: (stats) => stats.foodsEaten >= 750, reward: 38, xpReward: 150, category: 'progress' },
            { id: 'foods_eaten_2000', name: '食物吞噬者', description: '一共吃到2000个食物', condition: (stats) => stats.foodsEaten >= 2000, reward: 100, xpReward: 400, category: 'progress' },
            { id: 'foods_eaten_5000', name: '食物之神', description: '一共吃到5000个食物', condition: (stats) => stats.foodsEaten >= 5000, reward: 125, xpReward: 500, category: 'progress' },

            { id: 'first_game', name: '游戏教程', description: '第一次开始游戏', condition: (stats) => stats.gamesPlayed >= 1, reward: 2, xpReward: 5, category: 'progress' },
            { id: 'ten_games', name: '游戏老手', description: '玩10次游戏', condition: (stats) => stats.gamesPlayed >= 10, reward: 4, xpReward: 15, category: 'progress' },
            { id: 'games_played_30', name: '游戏迷', description: '玩30次游戏', condition: (stats) => stats.gamesPlayed >= 30, reward: 10, xpReward: 40, category: 'progress' },
            { id: 'games_played_50', name: '游戏狂人', description: '玩50次游戏', condition: (stats) => stats.gamesPlayed >= 50, reward: 12, xpReward: 50, category: 'progress' },
            { id: 'games_played_75', name: '游戏狂熱者', description: '玩75次游戏', reward: 20, xpReward: 80, condition: (stats) => stats.gamesPlayed >= 75, category: 'progress' },
            { id: 'hundred_games', name: '游戏达人', description: '玩100次游戏', condition: (stats) => stats.gamesPlayed >= 100, reward: 25, xpReward: 100, category: 'progress' },
            { id: 'two_hundred_games', name: '游戏宗师', description: '玩200次游戏', condition: (stats) => stats.gamesPlayed >= 200, reward: 50, xpReward: 200, category: 'progress' },
            { id: 'total_games_500', name: '游戏传奇', description: '玩500次游戏', condition: (stats) => stats.gamesPlayed >= 500, reward: 125, xpReward: 500, category: 'progress' },

            // Coin Master
            { id: 'first_coin', name: '金币菜鸟', description: '第一次获得金币', condition: (stats) => stats.totalCoinsEarned >= 1, reward: 2, xpReward: 5, category: 'coin_master' },
            { id: 'hundred_coins', name: '金币富翁', description: '累计100金币', condition: (stats) => stats.totalCoinsEarned >= 100, reward: 6, xpReward: 25, category: 'coin_master' },
            { id: 'total_coins_200', name: '小金库', description: '累计200金币', condition: (stats) => stats.totalCoinsEarned >= 200, reward: 9, xpReward: 35, category: 'coin_master' },
            { id: 'total_coins_300', name: '金币收集家', description: '累计300金币', condition: (stats) => stats.totalCoinsEarned >= 300, reward: 11, xpReward: 45, category: 'coin_master' },
            { id: 'thousand_coins', name: '金币大亨', description: '累计1000金币', condition: (stats) => stats.totalCoinsEarned >= 1000, reward: 25, xpReward: 100, category: 'coin_master' },
            { id: 'total_coins_1500', name: '金币富翁 II', description: '累计1500金币', condition: (stats) => stats.totalCoinsEarned >= 1500, reward: 38, xpReward: 150, category: 'coin_master' },
            { id: 'two_thousand_coins', name: '金币巨富', description: '累计2000金币', condition: (stats) => stats.totalCoinsEarned >= 2000, reward: 50, xpReward: 200, category: 'coin_master' },
            { id: 'five_thousand_coins', name: '金币帝王', description: '累计5000金币', condition: (stats) => stats.totalCoinsEarned >= 5000, reward: 125, xpReward: 500, category: 'coin_master' },
            { id: 'total_coins_10000', name: '金币神话', description: '累计10000金币', condition: (stats) => stats.totalCoinsEarned >= 10000, reward: 250, xpReward: 1000, category: 'coin_master' },

            { id: 'max_coins_in_game_50', name: '游戏金币王', description: '游戏获得50金币', condition: (stats) => stats.maxCoinsInGame >= 50, reward: 10, xpReward: 40, category: 'coin_master' },
            { id: 'max_coins_in_game_75', name: '游戏金币專家', description: '游戏获得75金币', condition: (stats) => stats.maxCoinsInGame >= 75, reward: 15, xpReward: 60, category: 'coin_master' },
            { id: 'max_coins_in_game_100', name: '游戏金币富豪', description: '游戏获得100金币', condition: (stats) => stats.maxCoinsInGame >= 100, reward: 20, xpReward: 80, category: 'coin_master' },
            { id: 'max_coins_in_game_150', name: '游戏金币大师', description: '游戏获得150金币', condition: (stats) => stats.maxCoinsInGame >= 150, reward: 25, xpReward: 100, category: 'coin_master' },
            { id: 'max_coins_in_game_200', name: '游戏金币傳奇', description: '游戏获得200金币', condition: (stats) => stats.maxCoinsInGame >= 200, reward: 38, xpReward: 150, category: 'coin_master' },

            { id: 'total_coins_spent_500', name: '金币挥霍者', description: '共计花费500金币', condition: (stats) => stats.totalCoinsSpent >= 500, reward: 12, xpReward: 50, category: 'coin_master' },
            { id: 'total_coins_spent_750', name: '金币挥霍者 II', description: '共计花费750金币', condition: (stats) => stats.totalCoinsSpent >= 750, reward: 18, xpReward: 70, category: 'coin_master' },
            { id: 'total_coins_spent_1000', name: '金币燃烧者', description: '共计花费1000金币', condition: (stats) => stats.totalCoinsSpent >= 1000, reward: 25, xpReward: 100, category: 'coin_master' },
            { id: 'total_coins_spent_1500', name: '金币燃烧者 II', description: '共计花费1500金币', condition: (stats) => stats.totalCoinsSpent >= 1500, reward: 30, xpReward: 120, category: 'coin_master' },
            { id: 'total_coins_spent_2000', name: '金币挥霍者 III', description: '共计花费2000金币', condition: (stats) => stats.totalCoinsSpent >= 2000, reward: 38, xpReward: 150, category: 'coin_master' },
            { id: 'total_coins_spent_3000', name: '金币燃烧者 III', description: '共计花费3000金币', condition: (stats) => stats.totalCoinsSpent >= 3000, reward: 50, xpReward: 200, category: 'coin_master' },
            { id: 'total_coins_spent_5000', name: '金币燃烧者 IV', description: '共计花费5000金币', condition: (stats) => stats.totalCoinsSpent >= 5000, reward: 75, xpReward: 300, category: 'coin_master' },

            // Powerup Expert
            { id: 'clear_obstacle_one', name: '障碍清除者', description: '清除1个障碍物', condition: (stats) => stats.obstaclesCleared >= 1, reward: 5, xpReward: 10, category: 'powerup_expert' },
            { id: 'obstacles_cleared_5', name: '障碍物終結者', description: '清除5个障碍物', condition: (stats) => stats.obstaclesCleared >= 5, reward: 12, xpReward: 50, category: 'powerup_expert' },

            { id: 'powerup_first', name: '道具初體驗', description: '第一次使用道具', condition: (stats) => stats.powerupsUsed >= 1, reward: 2, xpReward: 10, category: 'powerup_expert' },
            { id: 'powerup_any_five', name: '道具愛用者', description: '使用任意道具5次', condition: (stats) => stats.powerupsUsed >= 5, reward: 6, xpReward: 25, category: 'powerup_expert' },
            { id: 'powerup_any_ten', name: '道具達人', description: '使用任意道具10次', condition: (stats) => stats.powerupsUsed >= 10, reward: 12, xpReward: 50, category: 'powerup_expert' },
            { id: 'powerup_any_fifteen', name: '道具收藏家', description: '使用任意道具15次', condition: (stats) => stats.powerupsUsed >= 15, reward: 18, xpReward: 70, category: 'powerup_expert' },

            { id: 'shield_used', name: '護盾守護者', description: '使用1次護盾', condition: (stats) => stats.timesShieldUsed >= 1, reward: 4, xpReward: 15, category: 'powerup_expert' },
            { id: 'shield_used_five', name: '堅不可摧', description: '護盾抵擋5次碰撞', condition: (stats) => stats.timesShieldUsed >= 5, reward: 8, xpReward: 30, category: 'powerup_expert' },
            { id: 'extra_life_used', name: '不死傳說', description: '使用1次额外生命', condition: (stats) => stats.timesExtraLifeUsed >= 1, reward: 5, xpReward: 20, category: 'powerup_expert' },
            { id: 'extra_life_two', name: '2条命', description: '使用额外生命道具2次', condition: (stats) => stats.timesExtraLifeUsed >= 2, reward: 12, xpReward: 50, category: 'powerup_expert' },

            { id: 'teleport_five', name: '空间跳跃', description: '使用5次瞬間移動', condition: (stats) => stats.powerupsUsedByType.powerup_teleport >= 5, reward: 6, xpReward: 25, category: 'powerup_expert' },
            { id: 'teleport_ten', name: '瞬间移动大师', description: '使用瞬間移動道具10次', condition: (stats) => stats.powerupsUsedByType.powerup_teleport >= 10, reward: 10, xpReward: 40, category: 'powerup_expert' },
            { id: 'ghost_mode_three', name: '幽灵漫步', description: '使用3次幽灵模式', condition: (stats) => stats.powerupsUsedByType.powerup_ghost_mode >= 3, reward: 5, xpReward: 20, category: 'powerup_expert' },
            { id: 'ghost_mode_five', name: '幽灵行者', description: '使用5次幽灵模式', condition: (stats) => stats.powerupsUsedByType.powerup_ghost_mode >= 5, reward: 10, xpReward: 40, category: 'powerup_expert' },
            { id: 'shrink_snake_two', name: '縮骨功', description: '使用2次縮小蛇身', condition: (stats) => stats.powerupsUsedByType.powerup_shrink_snake >= 2, reward: 4, xpReward: 15, category: 'powerup_expert' },
            { id: 'shrink_snake_five', name: '縮身術', description: '使用縮小蛇身道具5次', condition: (stats) => stats.powerupsUsedByType.powerup_shrink_snake >= 5, reward: 8, xpReward: 30, category: 'powerup_expert' },
            { id: 'coin_boost_three', name: '金币狂熱', description: '使用金币加速道具3次', condition: (stats) => stats.powerupsUsedByType.powerup_coin_boost >= 3, reward: 10, xpReward: 40, category: 'powerup_expert' },
            { id: 'super_food_three', name: '超级美食家', description: '使用超级食物道具3次', condition: (stats) => stats.powerupsUsedByType.powerup_super_food >= 3, reward: 12, xpReward: 50, category: 'powerup_expert' },

            { id: 'use_all_powerups', name: '道具大师', description: '使用一次所有種類的道具', condition: (stats) => Object.keys(stats.powerupsUsedByType).length >= shopItemsData.filter(item => item.type === 'powerup').length, reward: 25, xpReward: 100, category: 'powerup_expert' },
            { id: 'all_powerups_master', name: '道具宗师', description: '使用一次所有種類的道具至少3次', condition: (stats) => Object.keys(stats.powerupsUsedByType).length >= shopItemsData.filter(item => item.type === 'powerup').length && shopItemsData.filter(item => item.type === 'powerup').every(p => stats.powerupsUsedByType[p.id] >= 3), reward: 75, xpReward: 300, category: 'powerup_expert' },


            // Map Explorer
            { id: 'unlock_forest_map', name: '森林探险', description: '解锁森林地图', condition: (stats) => stats.mapsUnlocked >= 1, reward: 5, xpReward: 20, category: 'map_explorer' },
            { id: 'unlock_desert_map', name: '沙漠求生', description: '解锁沙漠地图', condition: (stats) => stats.mapsUnlocked >= 2, reward: 12, xpReward: 50, category: 'map_explorer' },
            { id: 'unlock_all_maps', name: '地图探索家', description: '解锁所有地图', condition: (stats) => stats.mapsUnlocked >= maps.length, reward: 38, xpReward: 150, category: 'map_explorer' },

            { id: 'play_grassland_map', name: '草原漫遊者', description: '在草原地图玩一次游戏', condition: (stats) => stats.playedMaps.grassland >= 1, reward: 2, xpReward: 10, category: 'map_explorer' },
            { id: 'play_forest_map', name: '森林探险家', description: '在森林地图玩一次游戏', condition: (stats) => stats.playedMaps.forest >= 1, reward: 4, xpReward: 15, category: 'map_explorer' },
            { id: 'play_desert_map', name: '沙漠旅人', description: '在沙漠地图玩一次游戏', condition: (stats) => stats.playedMaps.desert >= 1, reward: 6, xpReward: 25, category: 'map_explorer' },
            { id: 'play_grassland_5', name: '草原常客', description: '在草原地图玩5次游戏', condition: (stats) => stats.playedMaps.grassland >= 5, reward: 2, xpReward: 10, category: 'map_explorer' },
            { id: 'play_grassland_10', name: '草原專家', description: '在草原地图玩10次游戏', condition: (stats) => stats.playedMaps.grassland >= 10, reward: 5, xpReward: 20, category: 'map_explorer' },
            { id: 'play_forest_3', name: '森林探险家 II', description: '在森林地图玩3次游戏', condition: (stats) => stats.playedMaps.forest >= 3, reward: 6, xpReward: 25, category: 'map_explorer' },
            { id: 'play_forest_5', name: '森林專家', description: '在森林地图玩5次游戏', condition: (stats) => stats.playedMaps.forest >= 5, reward: 10, xpReward: 40, category: 'map_explorer' },
            { id: 'play_desert_3', name: '沙漠生存者', description: '在沙漠地图玩3次游戏', condition: (stats) => stats.playedMaps.desert >= 3, reward: 10, xpReward: 40, category: 'map_explorer' },
            { id: 'play_desert_5', name: '沙漠專家', description: '在沙漠地图玩5次游戏', condition: (stats) => stats.playedMaps.desert >= 5, reward: 15, xpReward: 60, category: 'map_explorer' },
            { id: 'play_all_maps', name: '地图收藏家', description: '在所有地图玩一次游戏', condition: (stats) => maps.every(map => map.default || stats.playedMaps[map.id] >= 1), reward: 25, xpReward: 50, category: 'map_explorer' },
            { id: 'play_all_maps_5_times', name: '地图狂熱者', description: '在所有地图各玩5次游戏', condition: (stats) => maps.every(map => map.default || stats.playedMaps[map.id] >= 5), reward: 50, xpReward: 100, category: 'map_explorer' },

            { id: 'win_forest', name: '森林之王', description: '在森林地图道具一次', condition: (stats) => stats.wonGames.forest.anyPowerup >= 1, reward: 8, xpReward: 30, category: 'map_explorer' },
            { id: 'win_desert', name: '沙漠霸主', description: '在沙漠地图道具一次', condition: (stats) => stats.wonGames.desert.anyPowerup >= 1, reward: 12, xpReward: 50, category: 'map_explorer' },
            { id: 'win_all_maps_once', name: '地图征服者', description: '在所有地图道具一次', condition: (stats) => maps.every(map => map.default || stats.wonGames[map.id].anyPowerup >= 1), reward: 25, xpReward: 100, category: 'map_explorer' },
            { id: 'win_all_maps_no_powerup', name: '纯粹地图大师', description: '在所有地图不使用道具道具一次', condition: (stats) => maps.every(map => map.default || stats.wonGames[map.id].noPowerup >= 1), reward: 50, xpReward: 200, category: 'map_explorer' },
            { id: 'win_all_maps_no_powerup_master', name: '纯粹地图宗师', description: '在所有地图不使用道具道具3次', condition: (stats) => maps.every(map => map.default || stats.wonGames[map.id].noPowerup >= 3), reward: 125, xpReward: 500, category: 'map_explorer' },
            { id: 'win_forest_no_obstacle', name: '森林障碍物', description: '在森林地图清除障碍物後道具', condition: (stats) => stats.wonGames.forest.clearObstaclesUsed >= 1, reward: 12, xpReward: 50, category: 'map_explorer' },
            { id: 'win_forest_no_obstacle_3', name: '森林障碍物 II', description: '在森林地图清除障碍物後道具3次', condition: (stats) => stats.wonGames.forest.clearObstaclesUsed >= 3, reward: 20, xpReward: 80, category: 'map_explorer' },
            { id: 'win_desert_no_obstacle', name: '沙漠障碍物', description: '在沙漠地图清除障碍物後道具', condition: (stats) => stats.wonGames.desert.clearObstaclesUsed >= 1, reward: 18, xpReward: 70, category: 'map_explorer' },
            { id: 'win_desert_no_obstacle_3', name: '沙漠障碍物 II', description: '在沙漠地图清除障碍物後道具3次', condition: (stats) => stats.wonGames.desert.clearObstaclesUsed >= 3, reward: 25, xpReward: 100, category: 'map_explorer' },


            // Difficulty Challenge
            { id: 'unlock_medium_diff', name: '中等挑战', description: '解锁中等难度', condition: (stats) => stats.difficultiesUnlocked >= 1, reward: 5, xpReward: 20, category: 'difficulty_challenge' },
            { id: 'unlock_hard_diff', name: '困难征服', description: '解锁困难模式', condition: (stats) => stats.difficultiesUnlocked >= 2, reward: 12, xpReward: 50, category: 'difficulty_challenge' },
            { id: 'unlock_all_difficulties', name: '难度全開', description: '解锁所有难度', condition: (stats) => stats.difficultiesUnlocked >= difficulties.length, reward: 38, xpReward: 150, category: 'difficulty_challenge' },

            { id: 'play_easy_5_times', name: '简单模式愛好者', description: '在简单难度玩5次游戏', condition: (stats) => stats.playedDifficulties.easy >= 5, reward: 2, xpReward: 10, category: 'difficulty_challenge' },
            { id: 'play_easy_10_times', name: '简单模式大师', description: '在简单难度玩10次游戏', condition: (stats) => stats.playedDifficulties.easy >= 10, reward: 5, xpReward: 20, category: 'difficulty_challenge' },
            { id: 'play_medium_5_times', name: '中等模式挑战者', description: '在中等难度玩5次游戏', condition: (stats) => stats.playedDifficulties.medium >= 5, reward: 5, xpReward: 20, category: 'difficulty_challenge' },
            { id: 'play_medium_10_times', name: '中等模式大师', description: '在中等难度玩10次游戏', condition: (stats) => stats.playedDifficulties.medium >= 10, reward: 8, xpReward: 30, category: 'difficulty_challenge' },
            { id: 'play_hard_5_times', name: '困难模式征服者', description: '在困难模式玩5次游戏', condition: (stats) => stats.playedDifficulties.hard >= 5, reward: 10, xpReward: 40, category: 'difficulty_challenge' },
            { id: 'play_hard_10_times', name: '困难模式大师', description: '在困难模式玩10次游戏', condition: (stats) => stats.playedDifficulties.hard >= 10, reward: 15, xpReward: 60, category: 'difficulty_challenge' },
            { id: 'play_all_difficulties', name: '难度挑战者', description: '在所有难度玩一次游戏', condition: (stats) => difficulties.every(diff => stats.playedDifficulties[diff.id] >= 1), reward: 12, xpReward: 50, category: 'difficulty_challenge' },
            { id: 'play_all_difficulties_5_times', name: '难度征服者', description: '在所有难度各玩5次游戏', condition: (stats) => difficulties.every(diff => stats.playedDifficulties[diff.id] >= 5), reward: 25, xpReward: 100, category: 'difficulty_challenge' },

            { id: 'win_easy', name: '简单胜利', description: '在简单难度道具一次', condition: (stats) => stats.wonGames.easy.anyPowerup >= 1, reward: 2, xpReward: 10, category: 'difficulty_challenge' },
            { id: 'win_easy_5', name: '简单速通', description: '在简单难度道具5次', condition: (stats) => stats.wonGames.easy.anyPowerup >= 5, reward: 10, xpReward: 40, category: 'difficulty_challenge' },
            { id: 'win_easy_10', name: '简单模式大师', description: '在简单难度道具10次', condition: (stats) => stats.wonGames.easy.anyPowerup >= 10, reward: 15, xpReward: 60, category: 'difficulty_challenge' },
            { id: 'win_medium', name: '中等胜利', description: '在中等难度道具一次', condition: (stats) => stats.wonGames.medium.anyPowerup >= 1, reward: 5, xpReward: 20, category: 'difficulty_challenge' },
            { id: 'win_medium_3', name: '中等速通', description: '在中等难度道具3次', condition: (stats) => stats.wonGames.medium.anyPowerup >= 3, reward: 15, xpReward: 60, category: 'difficulty_challenge' },
            { id: 'win_medium_5', name: '中等模式大师', description: '在中等难度道具5次', condition: (stats) => stats.wonGames.medium.anyPowerup >= 5, reward: 20, xpReward: 80, category: 'difficulty_challenge' },
            { id: 'win_hard', name: '困难胜利', description: '在困难模式道具一次', condition: (stats) => stats.wonGames.hard.anyPowerup >= 1, reward: 10, xpReward: 40, category: 'difficulty_challenge' },
            { id: 'win_hard_2', name: '困难速通', description: '在困难模式道具2次', condition: (stats) => stats.wonGames.hard.anyPowerup >= 2, reward: 25, xpReward: 100, category: 'difficulty_challenge' },
            { id: 'win_hard_3', name: '困难模式大师', description: '在困难模式道具3次', condition: (stats) => stats.wonGames.hard.anyPowerup >= 3, reward: 38, xpReward: 150, category: 'difficulty_challenge' },
            { id: 'win_all_difficulties', name: '全难度征服', description: '在所有难度道具一次', condition: (stats) => stats.wonGames.easy.anyPowerup >= 1 && stats.wonGames.medium.anyPowerup >= 1 && stats.wonGames.hard.anyPowerup >= 1, reward: 25, xpReward: 100, category: 'difficulty_challenge' },

            { id: 'win_easy_no_powerup', name: '简单纯粹', description: '在简单难度不使用道具道具', condition: (stats) => stats.wonGames.easy.noPowerup >= 1, reward: 8, xpReward: 30, category: 'difficulty_challenge' },
            { id: 'win_easy_no_powerup_3', name: '简单纯粹 III', description: '在简单难度不使用道具道具3次', condition: (stats) => stats.wonGames.easy.noPowerup >= 3, reward: 12, xpReward: 50, category: 'difficulty_challenge' },
            { id: 'win_medium_no_powerup', name: '中等高手', description: '在中等难度不使用道具道具', condition: (stats) => stats.wonGames.medium.noPowerup >= 1, reward: 15, xpReward: 60, category: 'difficulty_challenge' },
            { id: 'win_medium_no_powerup_3', name: '中等高手 III', description: '在中等难度不使用道具道具3次', condition: (stats) => stats.wonGames.medium.noPowerup >= 3, reward: 25, xpReward: 100, category: 'difficulty_challenge' },
            { id: 'win_hard_no_powerup', name: '困难傳奇', description: '在困难模式不使用道具道具', condition: (stats) => stats.wonGames.hard.noPowerup >= 1, reward: 30, xpReward: 120, category: 'difficulty_challenge' },
            { id: 'win_hard_no_powerup_3', name: '困难傳奇 III', description: '在困难模式不使用道具道具3次', condition: (stats) => stats.wonGames.hard.noPowerup >= 3, reward: 50, xpReward: 200, category: 'difficulty_challenge' },
            { id: 'win_all_difficulties_no_powerup', name: '纯粹难度大师', description: '在所有难度不使用道具道具一次', condition: (stats) => difficulties.every(diff => stats.wonGames[diff.id].noPowerup >= 1), reward: 62, xpReward: 250, category: 'difficulty_challenge' },
            { id: 'win_all_difficulties_no_powerup_master', description: '在所有难度不使用道具道具3次', condition: (stats) => difficulties.every(diff => stats.wonGames[diff.id].noPowerup >= 3), reward: 125, xpReward: 500, category: 'difficulty_challenge' },
            { id: 'win_all_difficulties_no_powerup_all_maps', name: '纯粹全能王', description: '在所有难度、所有地图不使用道具道具一次', condition: (stats) => {
                const allDiffsNoPowerup = difficulties.every(diff => stats.wonGames[diff.id] && stats.wonGames[diff.id].noPowerup >= 1);
                const allMapsNoPowerup = maps.every(map => map.default || (stats.wonGames[map.id] && stats.wonGames[map.id].noPowerup >= 1));
                return allDiffsNoPowerup && allMapsNoPowerup;
            }, reward: 188, xpReward: 750, category: 'mastery' },


            // Skin Collector
            { id: 'purchase_skin_one', name: '时尚蛇', description: '购买1个蛇皮', condition: (stats) => stats.skinsPurchased >= 1, reward: 2, xpReward: 10, category: 'skin_collector' },
            { id: 'purchase_skin_three', name: '蛇皮愛好者', description: '购买3个蛇皮', condition: (stats) => stats.skinsPurchased >= 3, reward: 6, xpReward: 25, category: 'skin_collector' },
            { id: 'purchase_skin_five', name: '蛇皮喜爱着', description: '购买5个蛇皮', condition: (stats) => stats.skinsPurchased >= 5, reward: 10, xpReward: 40, category: 'skin_collector' },
            { id: 'purchase_skin_eight', name: '蛇皮狂热者', description: '购买8个蛇皮', condition: (stats) => stats.skinsPurchased >= 8, reward: 20, xpReward: 80, category: 'skin_collector' },
            { id: 'purchase_skin_nine', name: '蛇皮狂热者 II', description: '购买9个蛇皮', condition: (stats) => stats.skinsPurchased >= 9, reward: 22, xpReward: 90, category: 'skin_collector' },
            { id: 'collect_all_skins', name: '蛇皮收藏家', description: '收集所有蛇皮', condition: (stats) => stats.skinsPurchased >= shopItemsData.filter(item => item.type === 'skin').length, reward: 50, xpReward: 200, category: 'skin_collector' },

            { id: 'items_purchased_5', name: '小买家', description: '在商店购买5个物品', condition: (stats) => stats.itemsPurchased >= 5, reward: 5, xpReward: 20, category: 'skin_collector' },
            { id: 'items_purchased_7', name: '中等买家', description: '在商店购买7个物品', condition: (stats) => stats.itemsPurchased >= 7, reward: 8, xpReward: 30, category: 'skin_collector' },
            { id: 'items_purchased_10', name: '购物狂', description: '在商店购买10个物品', condition: (stats) => stats.itemsPurchased >= 10, reward: 12, xpReward: 50, category: 'skin_collector' },
            { id: 'items_purchased_15', name: '大買家', description: '在商店购买15个物品', condition: (stats) => stats.itemsPurchased >= 15, reward: 18, xpReward: 70, category: 'skin_collector' },
            { id: 'items_purchased_18', name: '超级买家', description: '在商店购买18个物品', condition: (stats) => stats.itemsPurchased >= 18, reward: 20, xpReward: 80, category: 'skin_collector' },
            { id: 'purchase_items_all', name: '商店清空者', description: '购买商店所有可购买物品', condition: (stats) => stats.itemsPurchased >= shopItemsData.filter(item => item.price > 0).length, reward: 75, xpReward: 300, category: 'skin_collector' },
            { id: 'collect_all_items', name: '商店清空者 II', description: '购买商店所有物品 (包括免費)', condition: (stats) => stats.itemsPurchased >= shopItemsData.length, reward: 125, xpReward: 500, category: 'skin_collector' },

            { id: 'played_all_skins', name: '蛇皮體驗家', description: '使用一次所有购买的蛇皮', condition: (stats) => Object.keys(purchasedItems).filter(id => shopItemsData.find(item => item.id === id && item.type === 'skin')).every(skinId => stats.playedSkins[skinId] >= 1), reward: 12, xpReward: 50, category: 'skin_collector' },
            { id: 'use_all_skin_skills', name: '技能大师', description: '使用一次所有皮膚的獨特技能', condition: (stats) => {
                const allSkinSkills = shopItemsData.filter(item => item.type === 'skin' && item.skillEffect).map(item => item.skillEffect.type);
                return allSkinSkills.every(skillType => {
                    if (skillType === 'passive_speed_boost' || skillType === 'start_grow' || skillType === 'start_bonus_coins' || skillType === 'start_shield' || skillType === 'food_blink_speed' || skillType === 'end_game_bonus_coins' || skillType === 'powerup_duration_boost' || skillType === 'random_passive_skill_at_start' || skillType === 'ghost_on_hit') {
                        return true; // These are passive or trigger at start/end, so just owning/playing is enough
                    } else if (skillType === 'lucky_coin') {
                        return stats.luckyCoinTriggered > 0;
                    } else if (skillType === 'turn_speed_boost') {
                        return stats.turnSpeedBoostTriggered > 0;
                    } else if (skillType === 'food_invincibility') {
                        return stats.foodInvincibilityTriggered > 0;
                    }
                    return false;
                });
            }, reward: 50, xpReward: 200, category: 'skin_collector' },
            { id: 'all_skins_skills_master', name: '技能宗师', description: '使用用所有蛇皮的独特技能至少5次', condition: (stats) => {
                const allSkinSkills = shopItemsData.filter(item => item.type === 'skin' && item.skillEffect).map(item => item.skillEffect.type);
                return allSkinSkills.every(skillType => {
                    if (skillType === 'passive_speed_boost' || skillType === 'start_grow' || skillType === 'start_bonus_coins' || skillType === 'start_shield' || skillType === 'food_blink_speed' || skillType === 'end_game_bonus_coins' || skillType === 'powerup_duration_boost' || skillType === 'random_passive_skill_at_start' || skillType === 'ghost_on_hit') {
                        return true;
                    } else if (skillType === 'lucky_coin') {
                        return stats.luckyCoinTriggered >= 5;
                    } else if (skillType === 'turn_speed_boost') {
                        return stats.turnSpeedBoostTriggered >= 5;
                    } else if (skillType === 'food_invincibility') {
                        return stats.foodInvincibilityTriggered >= 5;
                    }
                    return false;
                });
            }, reward: 75, xpReward: 300, category: 'skin_collector' },

            // Art of Dying
            { id: 'die_once', name: '失败乃成功之母', description: '第一次游戏结束', condition: (stats) => stats.gamesEnded >= 1, reward: 2, xpReward: 5, category: 'art_of_dying' },
            { id: 'die_ten_times', name: '菜就多练', description: '游戏结束10次', condition: (stats) => stats.gamesEnded >= 10, reward: 5, xpReward: 20, category: 'art_of_dying' },
            { id: 'total_deaths_50', name: '失败大师', description: '游戏结束50次', condition: (stats) => stats.gamesEnded >= 50, reward: 12, xpReward: 50, category: 'art_of_dying' },
            { id: 'total_deaths_100', name: '失败宗师 II', description: '游戏结束100次', condition: (stats) => stats.gamesEnded >= 100, reward: 25, xpReward: 100, category: 'art_of_dying' },

            { id: 'die_by_self', name: '自食恶果', description: '被自己撞死一次', condition: (stats) => stats.diedBySelf >= 1, reward: 2, xpReward: 10, category: 'art_of_dying' },
            { id: 'die_by_wall', name: '撞墙', description: '撞墙死亡一次', condition: (stats) => stats.diedByWall >= 1, reward: 2, xpReward: 10, category: 'art_of_dying' },
            { id: 'die_by_obstacle', name: '障碍物克星', description: '撞到障碍物死亡一次', condition: (stats) => stats.diedByObstacle >= 1, reward: 4, xpReward: 15, category: 'art_of_dying' },
            { id: 'died_by_all_types', name: '死法大全', description: '至少被自己、墙壁、障碍物各撞死一次', condition: (stats) => stats.diedBySelf >= 1 && stats.diedByWall >= 1 && stats.diedByObstacle >= 1, reward: 12, xpReward: 50, category: 'art_of_dying' },

            // Mastery (General game skill achievements)
            { id: 'score_50', name: '半百高手', description: '游戏分数到达50', condition: (stats) => stats.maxScore >= 50, reward: 8, xpReward: 30, category: 'mastery' },
            { id: 'score_100', name: '百尺史师', description: '游戏分数到达100', condition: (stats) => stats.maxScore >= 100, reward: 19, xpReward: 75, category: 'mastery' },
            { id: 'score_200', name: '二百传奇', description: '游戏分数到达200', condition: (stats) => stats.maxScore >= 200, reward: 25, xpReward: 100, category: 'mastery' },
            { id: 'score_500', name: '五百神话', description: '游戏分数到达500', condition: (stats) => stats.maxScore >= 500, reward: 62, xpReward: 250, category: 'mastery' },
            { id: 'score_1000', name: '千分王者', description: '游戏分数到达1000', condition: (stats) => stats.maxScore >= 1000, reward: 125, xpReward: 500, category: 'mastery' },

            { id: 'snake_length_10', name: '引蛇出洞', description: '蛇身到达10米', condition: (stats) => stats.maxSnakeLength >= 10, reward: 5, xpReward: 20, category: 'mastery' },
            { id: 'snake_length_15', name: '中型蛇', description: '蛇身到达15米', condition: (stats) => stats.maxSnakeLength >= 15, reward: 8, xpReward: 30, category: 'mastery' },
            { id: 'snake_length_20', name: '巨蟒降臨', description: '蛇身到达20米', condition: (stats) => stats.maxSnakeLength >= 20, reward: 12, xpReward: 50, category: 'mastery' },
            { id: 'snake_length_25', name: '大蛇', description: '蛇身到达25米', condition: (stats) => stats.maxSnakeLength >= 25, reward: 15, xpReward: 60, category: 'mastery' },
            { id: 'snake_length_30', name: '長龍出海', description: '蛇身到达30米', condition: (stats) => stats.maxSnakeLength >= 30, reward: 20, xpReward: 80, category: 'mastery' },
            { id: 'snake_length_40', name: '盤龍臥虎', description: '蛇身到达40米', condition: (stats) => stats.maxSnakeLength >= 40, reward: 30, xpReward: 120, category: 'mastery' },
            { id: 'snake_length_50', name: '騰龍在天', description: '蛇身到达50米', condition: (stats) => stats.maxSnakeLength >= 50, reward: 45, xpReward: 180, category: 'mastery' },
            { id: 'max_snake_length_75', name: '蛇神', description: '蛇身到达75米', condition: (stats) => stats.maxSnakeLength >= 75, reward: 62, xpReward: 250, category: 'mastery' },
            { id: 'max_snake_length_100', name: '蛇王', description: '蛇身到达100米', condition: (stats) => stats.maxSnakeLength >= 100, reward: 100, xpReward: 400, category: 'mastery' },

            { id: 'eat_5_in_row', name: '连吃五个', description: '连续吃到5个食物', condition: (stats) => stats.maxConsecutiveFoods >= 5, reward: 5, xpReward: 20, category: 'mastery' },
            { id: 'eat_10_in_row', name: '十连吃', description: '连续吃到10个食物', condition: (stats) => stats.maxConsecutiveFoods >= 10, reward: 12, xpReward: 50, category: 'mastery' },
            { id: 'eat_15_in_row', name: '十五连吃', description: '连续吃到15个食物', condition: (stats) => stats.maxConsecutiveFoods >= 15, reward: 18, xpReward: 70, category: 'mastery' },
            { id: 'eat_20_in_row', name: '二十连吃', description: '连续吃到20个食物', condition: (stats) => stats.maxConsecutiveFoods >= 20, reward: 25, xpReward: 100, category: 'mastery' },

            { id: 'no_collision_50_score', name: '完美', description: '在分数到达50前沒有碰撞', condition: (stats) => stats.perfectScore50 >= 1, reward: 10, xpReward: 40, category: 'mastery' },
            { id: 'no_collision_100_score', name: '完美 II', description: '在分数到达100前沒有碰撞', condition: (stats) => stats.perfectScore100 >= 1, reward: 20, xpReward: 80, category: 'mastery' },

            { id: 'total_score_1000', name: '分数一千', description: '累计分数到达1000', condition: (stats) => stats.totalScore >= 1000, reward: 12, xpReward: 50, category: 'mastery' },
            { id: 'total_score_5000', name: '分数五千', description: '累计分数到达5000', condition: (stats) => stats.totalScore >= 5000, reward: 38, xpReward: 150, category: 'mastery' },
            { id: 'total_score_10000', name: '分数一分', description: '累计分数到达10000', condition: (stats) => stats.totalScore >= 10000, reward: 75, xpReward: 300, category: 'mastery' },
            { id: 'total_score_20000', name: '分数二万', description: '累计分数到达20000', condition: (stats) => stats.totalScore >= 20000, reward: 100, xpReward: 400, category: 'mastery' },
            { id: 'total_score_50000', name: '分数五万', description: '累计分数到达50000', condition: (stats) => stats.totalScore >= 50000, reward: 175, xpReward: 700, category: 'mastery' },
            { id: 'total_score_100000', name: '分数十万', description: '累计分数到达100000', condition: (stats) => stats.totalScore >= 100000, reward: 250, xpReward: 1000, category: 'mastery' },

            { id: 'lucky_coin_triggered_10', name: '幸运星', description: '解锁幸运金币技能10次', condition: (stats) => stats.luckyCoinTriggered >= 10, reward: 8, xpReward: 30, category: 'mastery' },
            { id: 'lucky_coin_triggered_30', name: '超级幸运星', description: '解锁幸运金币技能30次', condition: (stats) => stats.luckyCoinTriggered >= 30, reward: 18, xpReward: 70, category: 'mastery' },

            { id: 'turn_speed_boost_20', name: '极速过弯', description: '解锁輕盈身姿技能20次', condition: (stats) => stats.turnSpeedBoostTriggered >= 20, reward: 8, xpReward: 30, category: 'mastery' },
            { id: 'turn_speed_boost_50', name: '极速弯道', description: '解锁輕盈身姿技能50次', condition: (stats) => stats.turnSpeedBoostTriggered >= 50, reward: 15, xpReward: 60, category: 'mastery' },

            { id: 'food_invincibility_5', name: '无敌蛇', description: '解锁光速反應技能5次', condition: (stats) => stats.foodInvincibilityTriggered >= 5, reward: 10, xpReward: 40, category: 'mastery' },
            { id: 'food_invincibility_15', name: '无敌蛇 II', description: '解锁光速反應技能15次', condition: (stats) => stats.foodInvincibilityTriggered >= 15, reward: 22, xpReward: 90, category: 'mastery' },

            { id: 'score_40_easy', name: '简单模式專家', description: '在简单难度游戏分数到达40', condition: (stats) => stats.maxScoreByDifficulty.easy >= 40, reward: 8, xpReward: 30, category: 'mastery' },
            { id: 'score_40_medium', name: '中等模式專家', description: '在中等难度游戏分数到达40', condition: (stats) => stats.maxScoreByDifficulty.medium >= 40, reward: 12, xpReward: 50, category: 'mastery' },
            { id: 'score_50_hard', name: '困难模式達人', description: '在困难模式游戏分数到达50', condition: (stats) => stats.maxScoreByDifficulty.hard >= 50, reward: 20, xpReward: 80, category: 'mastery' },
            { id: 'score_50_forest', name: '森林高手', description: '在森林地图游戏分数到达50', condition: (stats) => stats.maxScoreByMap.forest >= 50, reward: 10, xpReward: 40, category: 'mastery' },
            { id: 'score_50_desert', name: '沙漠高手', description: '在沙漠地图游戏分数到达50', condition: (stats) => stats.maxScoreByMap.desert >= 50, reward: 15, xpReward: 60, category: 'mastery' },
            { id: 'score_150_hard_no_powerup', name: '困难纯粹高分', description: '在困难模式不使用道具游戏分数到达150', condition: (stats) => stats.maxScoreByDifficulty.hardNoPowerup >= 150, reward: 50, xpReward: 200, category: 'mastery' },

            { id: 'score_50_no_powerup', name: 'nb高分', description: '不使用道具游戏分数到达50', condition: (stats) => stats.maxScoreNoPowerup >= 50, reward: 18, xpReward: 70, category: 'mastery' },
            { id: 'snake_length_20_no_powerup', name: '长蛇', description: '不使用道具蛇身到达20米', condition: (stats) => stats.maxSnakeLengthNoPowerup >= 20, reward: 20, xpReward: 80, category: 'mastery' },
            { id: 'snake_length_50_hard_no_powerup', name: '困难模式长蛇', description: '在困难模式不使用道具蛇身到达50米', condition: (stats) => stats.maxSnakeLengthByDifficulty.hardNoPowerup >= 50, reward: 62, xpReward: 250, category: 'mastery' },

            // Grand Master (Meta-achievements)
            { id: 'all_achievements_half', name: '50%成就', description: '完成50%的成就', condition: (stats) => Object.keys(stats.completedAchievements).length >= Math.floor(allAchievements.length / 2), reward: 38, xpReward: 150, category: 'grand_master' },
            { id: 'all_achievements_75_percent', name: '成就四分之三', description: '完成75%的成就', condition: (stats) => Object.keys(stats.completedAchievements).length >= Math.floor(allAchievements.length * 0.75), reward: 62, xpReward: 250, category: 'grand_master' },
            { id: 'all_achievements_90_percent', name: '成就近乎完美', description: '完成90%的成就', condition: (stats) => Object.keys(stats.completedAchievements).length >= Math.floor(allAchievements.length * 0.90), reward: 88, xpReward: 350, category: 'grand_master' },
            { id: 'all_achievements_completed', name: '游戏之神', description: '完成所有成就', condition: (stats) => Object.keys(stats.completedAchievements).length === allAchievements.length, reward: 250, xpReward: 1000, category: 'grand_master' },
        ];


        // Helper functions
        function getRandomGridPosition(currentSnake, existingFoods, obstacles) {
            let newPos;
            let collision;
            let attempts = 0;
            // Define the board area for food placement, excluding borders
            const minX = 1;
            const maxX = BOARD_WIDTH_CELLS - 2;
            const minY = 1;
            const maxY = BOARD_HEIGHT_CELLS - 2;

            const maxTotalAttempts = (maxX - minX + 1) * (maxY - minY + 1) * 5; // Max attempts within the valid area

            do {
                if (attempts > maxTotalAttempts) {
                    console.warn("Could not find a safe random position for food after many attempts. Board might be full or too crowded.");
                    return null; // Explicitly return null if no safe spot found
                }
                newPos = {
                    x: minX + Math.floor(Math.random() * (maxX - minX + 1)),
                    y: minY + Math.floor(Math.random() * (maxY - minY + 1))
                };
                collision = false;

                // Check collision with snake segments
                for (const segment of currentSnake) {
                    if (segment.x === newPos.x && segment.y === newPos.y) {
                        collision = true;
                        break;
                    }
                }

                // Check collision with existing food items (only if no collision yet)
                if (!collision) {
                    for (const existingFood of existingFoods) {
                        if (existingFood && newPos.x === existingFood.x && newPos.y === existingFood.y) {
                            collision = true;
                            break;
                        }
                    }
                }

                // Check collision with obstacles (only if no collision yet)
                if (!collision) {
                    for (const obstacle of obstacles) {
                        if (obstacle.x === newPos.x && obstacle.y === newPos.y) {
                            collision = true;
                            break;
                        }
                    }
                }

                attempts++;
            } while (collision); // Continue looping as long as a collision is detected
            return newPos;
        }

        async function saveState() {
            const dataToSave = {
                coins: coins,
                xp: xp,
                purchasedItems: purchasedItems,
                gameStats: gameStats,
                completedAchievements: completedAchievements,
                unlockedExclusiveRewards: unlockedExclusiveRewards,
                activeSkinId: activeSkinId,
            };

            if (isGuestUser) {
                localStorage.setItem('guestGameData', JSON.stringify(dataToSave));
                localStorage.setItem('guestProfile', JSON.stringify(userProfile));
            } else if (currentUserId) {
                const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/user_game_data`, 'gameData');
                const userProfileDocRef = doc(db, `artifacts/${appId}/public/data/users_public_profiles`, currentUserId);
                try {
                    await setDoc(userDocRef, dataToSave, { merge: true });
                    await setDoc(userProfileDocRef, {
                        uid: currentUserId,
                        displayName: userProfile.displayName,
                        avatar: userProfile.avatar,
                        level: userProfile.level,
                        xp: userProfile.xp,
                    }, { merge: true });
                } catch (e) {
                    console.error("Error saving state to Firebase: ", e);
                    showMessage('储存游戏难度失败！');
                }
            }
        }

        async function loadState() {
            // Define default gameStats structure for comprehensive initialization
            const defaultGameStats = {
                foodsEaten: 0, gamesPlayed: 0, totalCoinsEarned: 0, obstaclesCleared: 0, powerupsUsed: 0,
                timesShieldUsed: 0, timesExtraLifeUsed: 0, maxScore: 0, maxSnakeLength: 0, timesTeleported: 0,
                timesGhostModeUsed: 0, timesShrunkSnake: 0, difficultiesUnlocked: 0, mapsUnlocked: 0,
                skinsPurchased: 0, playedMaps: { grassland: 0, forest: 0, desert: 0 },
                playedDifficulties: { easy: 0, medium: 0, hard: 0 },
                wonGames: {
                    easy: { anyPowerup: 0, noPowerup: 0 }, medium: { anyPowerup: 0, noPowerup: 0 },
                    hard: { anyPowerup: 0, noPowerup: 0 }, forest: { anyPowerup: 0, noPowerup: 0, clearObstaclesUsed: 0 },
                    desert: { anyPowerup: 0, noPowerup: 0, clearObstaclesUsed: 0 },
                },
                maxConsecutiveFoods: 0, currentConsecutiveFoods: 0, perfectScore50: 0, perfectScore100: 0,
                powerupsUsedByType: {}, luckyCoinTriggered: 0, turnSpeedBoostTriggered: 0,
                foodInvincibilityTriggered: 0, itemsPurchased: 0, totalScore: 0, maxCoinsInGame: 0,
                totalCoinsSpent: 0, gamesEnded: 0, diedBySelf: 0, diedByWall: 0, diedByObstacle: 0,
                maxScoreByMap: { grassland: 0, forest: 0, desert: 0 },
                maxScoreByDifficulty: { easy: 0, medium: 0, hard: 0, hardNoPowerup: 0 },
                maxScoreNoPowerup: 0, maxSnakeLengthNoPowerup: 0,
                maxSnakeLengthByDifficulty: { easy: 0, medium: 0, hard: 0, hardNoPowerup: 0 },
                playedSkins: {}, completedAchievements: {},
            };

            const defaultPurchasedItems = {};
            shopItemsData.forEach(item => { if (item.default) defaultPurchasedItems[item.id] = true; });
            difficulties.forEach(diff => { if (diff.default) defaultPurchasedItems[`unlock_${diff.id}`] = true; });
            maps.forEach(map => { if (map.default) defaultPurchasedItems[`unlock_${map.id}`] = true; });

            let loadedData = null;
            let loadedProfile = null;

            if (isGuestUser) {
                const storedGameData = localStorage.getItem('guestGameData');
                const storedProfile = localStorage.getItem('guestProfile');
                if (storedGameData) loadedData = JSON.parse(storedGameData);
                if (storedProfile) loadedProfile = JSON.parse(storedProfile);
            } else if (currentUserId) {
                const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/user_game_data`, 'gameData');
                const userProfileDocRef = doc(db, `artifacts/${appId}/public/data/users_public_profiles`, currentUserId);
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) loadedData = docSnap.data();
                    const profileSnap = await getDoc(userProfileDocRef);
                    if (profileSnap.exists()) loadedProfile = profileSnap.data();
                } catch (e) {
                    console.error("Error loading state from Firebase: ", e);
                    showMessage('载入游戏难度失败！');
                }
            }

            // Apply loaded data or defaults
            coins = loadedData?.coins ?? 0;
            xp = loadedData?.xp ?? 0;
            purchasedItems = loadedData?.purchasedItems ? { ...defaultPurchasedItems, ...loadedData.purchasedItems } : defaultPurchasedItems;
            gameStats = loadedData?.gameStats ? { ...defaultGameStats, ...loadedData.gameStats } : defaultGameStats;
            completedAchievements = loadedData?.completedAchievements ? { ...loadedData.completedAchievements } : {};
            unlockedExclusiveRewards = loadedData?.unlockedExclusiveRewards ? { ...loadedData.unlockedExclusiveRewards } : {};
            activeSkinId = loadedData?.activeSkinId ?? 'skin_blue';

            // Ensure default skin is always marked as purchased
            const defaultSkin = shopItemsData.find(item => item.default && item.type === 'skin');
            if (defaultSkin) {
                purchasedItems[defaultSkin.id] = true;
            }

            // Ensure exclusive rewards are added to shopItemsData if unlocked
            for (const rewardId in unlockedExclusiveRewards) {
                if (unlockedExclusiveRewards[rewardId] && exclusiveRewards[rewardId]) {
                    const reward = exclusiveRewards[rewardId];
                    if (!shopItemsData.some(item => item.id === reward.id)) {
                        shopItemsData.push(reward);
                    }
                }
            }

            // Update user profile from loaded data or defaults
            userProfile.displayName = loadedProfile?.displayName ?? (isGuestUser ? 'Guest#' : '匿名玩家');
            userProfile.avatar = loadedProfile?.avatar ?? '😀';
            userProfile.level = loadedProfile?.level ?? (Math.floor(xp / XP_PER_LEVEL) + 1);
            userProfile.xp = loadedProfile?.xp ?? xp;

            level = userProfile.level; // Sync global level with userProfile

            // Ensure gameStats reflects current purchased items for achievement conditions
            gameStats.difficultiesUnlocked = Object.keys(purchasedItems).filter(id => id.startsWith('unlock_') && difficulties.some(d => `unlock_${d.id}` === id)).length;
            gameStats.mapsUnlocked = Object.keys(purchasedItems).filter(id => id.startsWith('unlock_') && maps.some(m => `unlock_${m.id}` === id)).length;
            gameStats.skinsPurchased = Object.keys(purchasedItems).filter(id => shopItemsData.some(item => item.id === id && item.type === 'skin')).length;
            gameStats.itemsPurchased = Object.keys(purchasedItems).length;
        }

        function showMessage(msg) {
            message = msg;
            renderPage();
            if (messageTimer) clearTimeout(messageTimer);
            messageTimer = setTimeout(() => {
                message = null;
                renderPage();
            }, 2000);
        }

        // Updated showAchievementNotification to use the provided file's style
        function showAchievementNotification(achievementName, coinReward, xpReward) {
            if (achievementNotificationTimer) clearTimeout(achievementNotificationTimer);

            const notificationHtml = `
                <div class="achievement-notification" id="achievementNotification">
                    <div class="trophy-icon-circle" id="trophyCircle">
                        <svg class="trophy-icon-svg" viewBox="0 0 32 32">
                            <path d="M8 6v4a8 8 0 0 0 16 0V6H8zm16 0h4a1 1 0 0 1 1 1v2c0 4-2.5 7-6 7v-2c2.5 0 4-2.5 4-5V7a1 1 0 0 1 1-1zm-20 0h4v2c0 2.5 1.5 5 4 5v2c-3.5 0-6-3-6-7V7a1 1 0 0 1 1-1zm8 19.7A6.5 6.5 0 0 0 22 19h-2a4.5 4.5 0 0 1-8 0H8a6.5 6.5 0 0 0 6 6.7z"/>
                        </svg>
                    </div>
                    <div class="notification-content" id="notificationContent">
                        <span class="achievement-name">${achievementName}</span>
                        <span class="achievement-rewards">
                            ${coinReward > 0 ? `+${coinReward} 金币 ` : ''}
                            ${xpReward > 0 ? `+${xpReward} 经验值` : ''}
                        </span>
                    </div>
                </div>
            `;
            achievementNotificationContainer.innerHTML = notificationHtml;

            // Get elements for animation
            const notificationElem = document.getElementById('achievementNotification');
            const trophyCircle = document.getElementById('trophyCircle');
            const notificationContent = document.getElementById('notificationContent');

            // Play audio (if any)
            const achievementAudio = document.getElementById('achievementAudio');
            if (achievementAudio) {
                achievementAudio.currentTime = 0;
                achievementAudio.play();
            }

            // Initial state (circle only)
            notificationContent.style.display = 'none';
            notificationElem.style.width = '60px';
            notificationElem.style.padding = '0';
            notificationElem.style.borderRadius = '50%';
            notificationElem.style.opacity = '0'; // Start hidden for expandNotification animation

            // Trigger popCircle animation
            trophyCircle.style.animation = 'popCircle 0.5s cubic-bezier(.62,1.17,.84,1) forwards';

            // Expand notification after a delay, and then fade out after another delay
            setTimeout(() => {
                notificationElem.classList.add('expanded');
                notificationContent.style.display = 'flex';
                notificationElem.style.width = ''; // Let CSS animation handle width
                notificationElem.style.padding = ''; // Let CSS animation handle padding
                notificationElem.style.borderRadius = ''; // Let CSS animation handle border-radius
                notificationElem.style.animation = 'expandNotification 1s cubic-bezier(.62,1.17,.84,1) forwards'; // Re-apply expand animation
            }, 500); // Delay for popCircle animation

            achievementNotificationTimer = setTimeout(() => {
                // Start fade out animation
                notificationElem.style.animation = 'fadeOutNotification 0.7s forwards';
                notificationElem.addEventListener('animationend', () => {
                    achievementNotificationContainer.innerHTML = ''; // Clear after fade out
                }, { once: true });
            }, 3000); // Total duration before fade out starts (e.g., 3s display)
        }

        function showExclusiveRewardNotification(rewardName) {
            if (achievementNotificationTimer) clearTimeout(achievementNotificationTimer);

            const notificationHtml = `
                <div class="achievement-notification" id="achievementNotification" style="background: linear-gradient(90deg, #9333ea 0%, #c084fc 100%);">
                    <div class="trophy-icon-circle" id="trophyCircle" style="background: #e879f9;">
                        <span class="trophy-icon-svg" style="font-size: 28px; color: white;">⭐</span>
                    </div>
                    <div class="notification-content" id="notificationContent">
                        <span class="achievement-name">解锁独家奖励！</span>
                        <span class="achievement-rewards">${rewardName}</span>
                    </div>
                </div>
            `;
            achievementNotificationContainer.innerHTML = notificationHtml;

            // Get elements for animation
            const notificationElem = document.getElementById('achievementNotification');
            const trophyCircle = document.getElementById('trophyCircle');
            const notificationContent = document.getElementById('notificationContent');

            // Play audio (if any) - can add a different audio for exclusive rewards
            const achievementAudio = document.getElementById('achievementAudio');
            if (achievementAudio) {
                achievementAudio.currentTime = 0;
                achievementAudio.play();
            }

            // Initial state (circle only)
            notificationContent.style.display = 'none';
            notificationElem.style.width = '60px';
            notificationElem.style.padding = '0';
            notificationElem.style.borderRadius = '50%';
            notificationElem.style.opacity = '0'; // Start hidden for expandNotification animation

            // Trigger popCircle animation
            trophyCircle.style.animation = 'popCircle 0.5s cubic-bezier(.62,1.17,.84,1) forwards';

            // Expand notification after a delay, and then fade out after another delay
            setTimeout(() => {
                notificationElem.classList.add('expanded');
                notificationContent.style.display = 'flex';
                notificationElem.style.width = ''; // Let CSS animation handle width
                notificationElem.style.padding = ''; // Let CSS animation handle padding
                notificationElem.style.borderRadius = ''; // Let CSS animation handle border-radius
                notificationElem.style.animation = 'expandNotification 1s cubic-bezier(.62,1.17,.84,1) forwards'; // Re-apply expand animation
            }, 500); // Delay for popCircle animation

            achievementNotificationTimer = setTimeout(() => {
                // Start fade out animation
                notificationElem.style.animation = 'fadeOutNotification 0.7s forwards';
                notificationElem.addEventListener('animationend', () => {
                    achievementNotificationContainer.innerHTML = ''; // Clear after fade out
                }, { once: true });
            }, 4000); // Longer total duration for exclusive rewards
        }

        // New: Level Up Animation Function
        function showLevelUpAnimation(oldLevel, newLevel) {
            if (levelUpNotificationTimer) clearTimeout(levelUpNotificationTimer);

            levelUpNotificationContainer.innerHTML = `
                <div id="level-up-popup" class="level-up-notification">
                    <p>等级提升！</p>
                    <p>
                        <span class="old-level">等级 ${oldLevel}</span>
                        <span class="new-level">等级 ${newLevel}</span>
                    </p>
                </div>
            `;
            const popup = document.getElementById('level-up-popup');

            // Show old level, then transition to new level
            setTimeout(() => {
                if (popup) {
                    popup.classList.add('show-new');
                }
            }, 500); // After 0.5s, transition to new level

            // Fade out the entire popup after showing the new level
            levelUpNotificationTimer = setTimeout(() => {
                if (popup) {
                    popup.classList.add('fade-out');
                    popup.addEventListener('animationend', () => {
                        levelUpNotificationContainer.innerHTML = ''; // Remove after fade out
                    }, { once: true });
                }
            }, 2000); // Total display time for animation (e.g., 2s)
        }


        function getActiveSkin() {
            return shopItemsData.find(item => item.id === activeSkinId);
        }

        function getMapObstacles(mapId) {
            const mapData = maps.find(map => map.id === mapId);
            return mapData ? mapData.obstacles : [];
        }

        async function checkAchievements() {
            let newAchievementsUnlocked = false;
            let oldLevel = level; // Store old level before checking for new level
            allAchievements.forEach(achievement => {
                if (!completedAchievements[achievement.id] && achievement.condition(gameStats)) {
                    completedAchievements[achievement.id] = true;
                    coins += achievement.reward;
                    xp += achievement.xpReward; // Add XP
                    showAchievementNotification(achievement.name, achievement.reward, achievement.xpReward);
                    newAchievementsUnlocked = true;

                    const newLevel = Math.floor(xp / XP_PER_LEVEL) + 1;
                    if (newLevel > oldLevel) { // Use oldLevel to detect actual level up
                        level = newLevel;
                        userProfile.level = newLevel; // Update userProfile level
                        showLevelUpAnimation(oldLevel, newLevel); // Trigger level up animation
                    }
                }
            });

            // Check for category completion and unlock exclusive rewards
            achievementCategories.forEach(category => {
                if (category.exclusiveReward && !unlockedExclusiveRewards[category.exclusiveReward.id]) {
                    const allCategoryAchievementsCompleted = category.achievements.every(achId => completedAchievements[achId]);
                    if (allCategoryAchievementsCompleted) {
                        unlockedExclusiveRewards[category.exclusiveReward.id] = true;
                        // Add the exclusive reward to shopItemsData so it can be 'activated' if it's a skin
                        const reward = category.exclusiveReward;
                        if (!shopItemsData.some(item => item.id === reward.id)) {
                            shopItemsData.push(reward);
                        }
                        showExclusiveRewardNotification(reward.name);
                        newAchievementsUnlocked = true;
                    }
                }
            });

            if (newAchievementsUnlocked || level > oldLevel) { // Save if achievements unlocked or level changed
                await saveState(); // Save state if new achievements, exclusive rewards, or level up
                renderPage(); // Re-render to update coin/xp/level display and achievement page
            }
        }

        // Game Logic Functions
        function startGameLoop() {
            if (gameInterval) clearInterval(gameInterval);

            gameInterval = setInterval(async () => { // Made async to await saveState
                const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

                let collisionDetected = false;
                let collisionType = null;

                const isCollidingWithWall = head.x < 0 || head.x >= BOARD_WIDTH_CELLS || head.y < 0 || head.y >= BOARD_HEIGHT_CELLS;
                const isCollidingWithSelf = snake.some((segment, i) => i !== 0 && head.x === segment.x && head.y === segment.y);
                const isCollidingWithObstacle = currentMapObstacles.some(obstacle => head.x === obstacle.x && head.y === obstacle.y);

                if (isCollidingWithWall) { collisionDetected = true; collisionType = 'wall'; }
                else if (isCollidingWithSelf) { collisionDetected = true; collisionType = 'self'; }
                else if (isCollidingWithObstacle) { collisionDetected = true; collisionType = 'obstacle'; }

                // Update gameStats for perfect score achievements
                if (!collisionDetected && score < 100) { // Only track up to score 100 for perfect score
                    if (score >= 50 && !gameStats.perfectScore50) gameStats.perfectScore50 = 1;
                    if (score >= 100 && !gameStats.perfectScore100) gameStats.perfectScore100 = 1;
                }


                if (invincibilityActive || isGhostModeActive) {
                    if (isGhostModeActive) {
                        if (head.x < 0) head.x = BOARD_WIDTH_CELLS - 1;
                        if (head.x >= BOARD_WIDTH_CELLS) head.x = 0;
                        if (head.y < 0) head.y = BOARD_HEIGHT_CELLS - 1;
                        if (head.y >= BOARD_HEIGHT_CELLS) head.y = 0;
                    }
                } else if (currentShield > 0 && collisionDetected) {
                    currentShield--;
                    gameStats.timesShieldUsed++; // Track shield usage for achievements
                    showMessage('盾牌已消耗！');
                    collisionDetected = false; // Shield absorbs the hit
                } else if (extraLives > 0 && collisionDetected) {
                    extraLives--;
                    gameStats.timesExtraLifeUsed++; // Track extra life usage for achievements
                    showMessage('额外生命已消耗！');
                    // Reset game state after using extra life
                    snake = [{ x: 10, y: 10 }];
                    foods = [];
                    for (let i = 0; i < NUM_INITIAL_FOODS; i++) {
                        const newFoodPos = getRandomGridPosition(snake, foods, currentMapObstacles);
                        if (newFoodPos) foods.push(newFoodPos);
                        else showMessage('空间不足，无法生成食物！'); // Message if initial food cannot be placed
                    }
                    direction = { x: 0, y: -1 };
                    lastDirection = { x: 0, y: -1 };
                    renderPage();
                    return;
                } else if (collisionDetected) {
                    // Check for ghostly skin skill
                    const activeSkin = getActiveSkin();
                    if (activeSkin && activeSkin.skillEffect && activeSkin.skillEffect.type === 'ghost_on_hit' && Math.random() < activeSkin.skillEffect.chance) {
                        isGhostModeActive = true;
                        if (ghostModeTimer) clearTimeout(ghostModeTimer);
                        ghostModeTimer = setTimeout(() => {
                            isGhostModeActive = false;
                            renderPage();
                        }, activeSkin.skillEffect.duration);
                        showMessage('幽灵附身啟動！');
                        // Continue game, collision is absorbed by ghost mode
                        collisionDetected = false;
                    } else {
                        isGameOver = true;
                        // Update gameStats for death types
                        if (collisionType === 'self') gameStats.diedBySelf++;
                        else if (collisionType === 'wall') gameStats.diedByWall++;
                        else if (collisionType === 'obstacle') gameStats.diedByObstacle++;
                        await handleGameOver();
                        return;
                    }
                }

                snake.unshift(head);

                let foodEatenIndex = -1;
                for (let i = 0; i < foods.length; i++) { // Corrected loop condition
                    if (head.x === foods[i].x && head.y === foods[i].y) {
                        foodEatenIndex = i;
                        break;
                    }
                }

                if (foodEatenIndex !== -1) {
                    // Base score and coin increase based on level
                    let scoreIncrease = 1 + (level - 1);
                    let coinsEarned = COIN_PER_FOOD + (level - 1);

                    gameStats.foodsEaten++; // Track foods eaten for achievements
                    gameStats.currentConsecutiveFoods++;
                    if (gameStats.currentConsecutiveFoods > gameStats.maxConsecutiveFoods) {
                        gameStats.maxConsecutiveFoods = gameStats.currentConsecutiveFoods;
                    }

                    if (isSuperFoodActive) {
                        scoreIncrease += superFoodBonus.score;
                        coinsEarned += superFoodBonus.coins;
                        isSuperFoodActive = false;
                        superFoodBonus = { score: 0, coins: 0 };
                        showMessage('超级食物效果强劲！');
                    }

                    const activeSkin = getActiveSkin();
                    if (activeSkin && activeSkin.skillEffect) {
                        switch (activeSkin.skillEffect.type) {
                            case 'extra_coin':
                                coinsEarned += activeSkin.skillEffect.value;
                                break;
                            case 'lucky_coin':
                                if (Math.random() < activeSkin.skillEffect.chance) {
                                    coinsEarned += 1;
                                    gameStats.luckyCoinTriggered++; // Track skill usage
                                    showMessage('幸运金币！');
                                }
                                break;
                            case 'food_invincibility':
                                invincibilityActive = true;
                                gameStats.foodInvincibilityTriggered++; // Track skill usage
                                if (invincibilityTimer) clearTimeout(invincibilityTimer);
                                invincibilityTimer = setTimeout(() => {
                                    invincibilityActive = false;
                                    renderPage();
                                }, activeSkin.skillEffect.duration);
                                break;
                            default:
                                break;
                        }
                    }

                    if (isDoubleScoreActive) {
                        scoreIncrease *= 2;
                        coinsEarned *= 2;
                    }
                    if (isCoinBoostActive) {
                        const coinBoostItem = shopItemsData.find(item => item.effect === 'coin_boost');
                        coinsEarned *= (coinBoostItem ? coinBoostItem.value : 2);
                    }
                    // Apply exclusive skill: Coin Frenzy
                    if (powerupActive && powerupActive.type === 'coin_frenzy') {
                        coinsEarned *= 3; // Triple coins
                    }


                    score += scoreIncrease;
                    coins += coinsEarned;
                    lastGameCoins += coinsEarned;
                    gameStats.totalCoinsEarned += coinsEarned; // Track total coins earned

                    foods.splice(foodEatenIndex, 1);
                    const newFoodPos = getRandomGridPosition(snake, foods, currentMapObstacles);
                    if (newFoodPos) {
                        foods.push(newFoodPos);
                    } else {
                        showMessage('空间不足，无法生成食物！'); // Message if new food cannot be placed
                    }
                    await saveState(); // Save state after eating food
                    await checkAchievements(); // Check for achievements after eating food
                } else {
                    snake.pop();
                    gameStats.currentConsecutiveFoods = 0; // Reset consecutive foods if no food eaten
                }

                // Update max snake length
                if (snake.length > gameStats.maxSnakeLength) {
                    gameStats.maxSnakeLength = snake.length;
                }
                // Update max snake length for no powerup games
                if (!powerupsUsedThisGame && snake.length > gameStats.maxSnakeLengthNoPowerup) {
                    gameStats.maxSnakeLengthNoPowerup = snake.length;
                }
                // Update max snake length by difficulty for no powerup games
                if (!powerupsUsedThisGame && snake.length > gameStats.maxSnakeLengthByDifficulty[`${selectedDifficultyId}NoPowerup`]) {
                    gameStats.maxSnakeLengthByDifficulty[`${selectedDifficultyId}NoPowerup`] = snake.length;
                }

                renderPage(); // Re-render to update game board
            }, gameSpeed);
        }

        async function handleGameOver() {
            clearInterval(gameInterval);
            gameStats.gamesEnded++; // Track games ended for achievements
            // Convert score to XP and add to total XP
            const xpEarnedFromScore = score * SCORE_TO_XP_MULTIPLIER;
            xp += xpEarnedFromScore;
            level = Math.floor(xp / XP_PER_LEVEL) + 1; // Recalculate level after adding XP
            userProfile.level = level; // Update userProfile level
            userProfile.xp = xp; // Update userProfile XP
            gameStats.totalScore += score; // Add current score to total (for maxScore tracking)

            if (lastGameCoins > gameStats.maxCoinsInGame) {
                gameStats.maxCoinsInGame = lastGameCoins; // Update max coins in a single game
            }
            if (score > gameStats.maxScore) {
                gameStats.maxScore = score; // Update max score
            }
            // Update max score by map and difficulty
            if (score > gameStats.maxScoreByMap[selectedMapId]) {
                gameStats.maxScoreByMap[selectedMapId] = score;
            }
            if (score > gameStats.maxScoreByDifficulty[selectedDifficultyId]) {
                gameStats.maxScoreByDifficulty[selectedDifficultyId] = score;
            }
            // Update max score for no powerup games
            if (!powerupsUsedThisGame && score > gameStats.maxScoreNoPowerup) {
                gameStats.maxScoreNoPowerup = score;
            }
            // Update max score by difficulty for no powerup games
            if (!powerupsUsedThisGame && score > gameStats.maxScoreByDifficulty[`${selectedDifficultyId}NoPowerup`]) {
                gameStats.maxScoreByDifficulty[`${selectedDifficultyId}NoPowerup`] = score;
            }

            // Check for winning conditions for achievements
            if (score > 0) { // Assuming a win means getting some score
                if (!gameStats.wonGames[selectedDifficultyId]) gameStats.wonGames[selectedDifficultyId] = {};
                if (!gameStats.wonGames[selectedDifficultyId].anyPowerup) gameStats.wonGames[selectedDifficultyId].anyPowerup = 0;
                gameStats.wonGames[selectedDifficultyId].anyPowerup++;

                if (!powerupsUsedThisGame) {
                    if (!gameStats.wonGames[selectedDifficultyId].noPowerup) gameStats.wonGames[selectedDifficultyId].noPowerup = 0;
                    gameStats.wonGames[selectedDifficultyId].noPowerup++;
                }

                if (!gameStats.wonGames[selectedMapId]) gameStats.wonGames[selectedMapId] = {};
                if (!gameStats.wonGames[selectedMapId].anyPowerup) gameStats.wonGames[selectedMapId].anyPowerup = 0;
                gameStats.wonGames[selectedMapId].anyPowerup++;

                if (!powerupsUsedThisGame) {
                    if (!gameStats.wonGames[selectedMapId].noPowerup) gameStats.wonGames[selectedMapId].noPowerup = 0;
                    gameStats.wonGames[selectedMapId].noPowerup++;
                }

                // Specific for clear_obstacles achievements
                if (selectedMapId === 'forest' && currentMapObstacles.length === 0 && powerupsUsedThisGame) { // Assuming clear_obstacles was used
                    if (!gameStats.wonGames.forest.clearObstaclesUsed) gameStats.wonGames.forest.clearObstaclesUsed = 0;
                    gameStats.wonGames.forest.clearObstaclesUsed++;
                }
                if (selectedMapId === 'desert' && currentMapObstacles.length === 0 && powerupsUsedThisGame) { // Assuming clear_obstacles was used
                    if (!gameStats.wonGames.desert.clearObstaclesUsed) gameStats.wonGames.desert.clearObstaclesUsed = 0;
                    gameStats.wonGames.desert.clearObstaclesUsed++;
                }
            }


            const activeSkin = getActiveSkin();
            if (activeSkin && activeSkin.skillEffect && activeSkin.skillEffect.type === 'end_game_bonus_coins') {
                coins += activeSkin.skillEffect.value;
                gameStats.totalCoinsEarned += activeSkin.skillEffect.value; // Track coins from skill
                showMessage(`额外获得 ${activeSkin.skillEffect.value} 金币！`);
            }
            await saveState(); // Save state after game over
            await checkAchievements(); // Check for achievements after game over
            currentPage = 'gameOver';
            renderPage();
        }

        async function resetGame() {
            score = 0;
            lastGameCoins = 0;
            snake = [{ x: 10, y: 10 }];
            direction = { x: 0, y: -1 };
            lastDirection = { x: 0, y: -1 };
            isGameOver = false;
            powerupActive = null;
            message = null;
            currentShield = 0;
            invincibilityActive = false;
            foodBlinkSpeed = 1.5;
            isDoubleScoreActive = false;
            if (doubleScoreTimer) clearTimeout(doubleScoreTimer);
            extraLives = 0;
            isGhostModeActive = false;
            if (ghostModeTimer) clearTimeout(ghostModeTimer);
            isCoinBoostActive = false;
            if (coinBoostTimer) clearTimeout(coinBoostTimer);
            isSuperFoodActive = false;
            superFoodBonus = { score: 0, coins: 0 };

            // Reset gameStats for current game
            gameStats.currentConsecutiveFoods = 0;
            powerupsUsedThisGame = false; // Reset flag for no-powerup achievements

            // Update gameStats for games played
            gameStats.gamesPlayed++;
            gameStats.playedMaps[selectedMapId] = (gameStats.playedMaps[selectedMapId] || 0) + 1;
            gameStats.playedDifficulties[selectedDifficultyId] = (gameStats.playedDifficulties[selectedDifficultyId] || 0) + 1;


            // Initialize currentMapObstacles based on selected map
            currentMapObstacles = getMapObstacles(selectedMapId);

            // Apply active skin's start-of-game skills
            const activeSkin = getActiveSkin();
            let initialGameSpeed = difficulties.find(d => d.id === selectedDifficultyId)?.speed || INITIAL_SPEED;
            if (activeSkin && activeSkin.skillEffect) {
                switch (activeSkin.skillEffect.type) {
                    case 'passive_speed_boost':
                        initialGameSpeed += activeSkin.skillEffect.value;
                        break;
                    case 'start_grow':
                        for (let i = 0; i < activeSkin.skillEffect.value; i++) {
                            snake.push({ x: 10, y: 10 + (i + 1) });
                        }
                        break;
                    case 'start_bonus_coins':
                        coins += activeSkin.skillEffect.value;
                        gameStats.totalCoinsEarned += activeSkin.skillEffect.value; // Track coins from skill
                        break;
                    case 'start_shield':
                        currentShield = activeSkin.skillEffect.value;
                        break;
                    case 'food_blink_speed':
                        foodBlinkSpeed = 1.5 * activeSkin.skillEffect.value;
                        break;
                    case 'random_passive_skill_at_start':
                        // Find all owned passive skills (excluding itself)
                        const ownedPassiveSkills = shopItemsData.filter(item =>
                            (item.type === 'skin' && purchasedItems[item.id] && item.id !== activeSkinId && item.skillEffect &&
                            (item.skillEffect.type === 'passive_speed_boost' || item.skillEffect.type === 'start_grow' || item.skillEffect.type === 'start_bonus_coins' || item.skillEffect.type === 'start_shield' || item.skillEffect.type === 'food_blink_speed' || item.skillEffect.type === 'end_game_bonus_coins'))
                        );
                        if (ownedPassiveSkills.length > 0) {
                            const randomSkill = ownedPassiveSkills[Math.floor(Math.random() * ownedPassiveSkills.length)].skillEffect;
                            if (randomSkill) {
                                switch (randomSkill.type) {
                                    case 'passive_speed_boost':
                                        initialGameSpeed += randomSkill.value;
                                        showMessage(`获得奖励：火焰加速！`);
                                        break;
                                    case 'start_grow':
                                        for (let i = 0; i < randomSkill.value; i++) {
                                            snake.push({ x: 10, y: 10 + (i + 1) });
                                        }
                                        showMessage(`获得奖励：自然成长！`);
                                        break;
                                    case 'start_bonus_coins':
                                        coins += randomSkill.value;
                                        gameStats.totalCoinsEarned += randomSkill.value;
                                        showMessage(`获得奖励：低调前行！`);
                                        break;
                                    case 'start_shield':
                                        currentShield += randomSkill.value;
                                        showMessage(`获得奖励：坚韧皮肤！`);
                                        break;
                                    case 'food_blink_speed':
                                        foodBlinkSpeed = 1.5 * randomSkill.value;
                                        showMessage(`获得奖励：食物感應！`);
                                        break;
                                    case 'end_game_bonus_coins':
                                        // This skill applies at game end, so no immediate effect
                                        showMessage(`获得奖励：金币奖励 `);
                                        break;
                                }
                            }
                        }
                        break;
                    default:
                        break;
                }
            }
            gameSpeed = initialGameSpeed;

            // Generate initial food items
            foods = [];
            for (let i = 0; i < NUM_INITIAL_FOODS; i++) {
                const newFoodPos = getRandomGridPosition(snake, foods, currentMapObstacles);
                if (newFoodPos) { // Only add food if a valid position is found
                    foods.push(newFoodPos);
                } else {
                    showMessage('空间不足，无法生成食物！'); // Message if initial food cannot be placed
                }
            }

            await saveState();
            await checkAchievements(); // Check for achievements after game start
            currentPage = 'game';
            startGameLoop();
            renderPage();
        }

        async function buyItem(item) {
            if (coins >= item.price) {
                coins -= item.price;
                gameStats.totalCoinsSpent += item.price; // Track coins spent
                purchasedItems[item.id] = true;
                gameStats.itemsPurchased++; // Track items purchased

                if (item.type === 'unlock_difficulty') {
                    gameStats.difficultiesUnlocked++;
                } else if (item.type === 'unlock_map') {
                    gameStats.mapsUnlocked++;
                } else if (item.type === 'skin') {
                    gameStats.skinsPurchased++;
                }

                await saveState();
                showMessage(`${item.name} 已购买！`);
                renderPage();
                await checkAchievements(); // Check for achievements after purchase
            } else {
                showMessage('金币不足！');
            }
        }

        async function activateSkin(skinId) {
            activeSkinId = skinId;
            gameStats.playedSkins[skinId] = (gameStats.playedSkins[skinId] || 0) + 1; // Track skin usage
            showMessage('蛇皮已更换！');
            await saveState(); // Save state immediately after activating skin
            renderPage();
            await checkAchievements(); // Check for achievements after activating skin
        }

        async function usePowerup(powerup) {
            // Adjust powerup duration if Rainbow Skin is active
            let actualDuration = powerup.duration;
            const activeSkin = getActiveSkin();
            if (activeSkin && activeSkin.skillEffect && activeSkin.skillEffect.type === 'powerup_duration_boost') {
                actualDuration += activeSkin.skillEffect.value;
            }

            if (powerup.duration && powerupActive && powerupActive.type === powerup.effect) {
                showMessage('此道具已起用！');
                return false;
            }

            if (purchasedItems[powerup.id] || unlockedExclusiveRewards[powerup.id]) { // Allow using exclusive powerups
                gameStats.powerupsUsed++; // Track total powerups used
                gameStats.powerupsUsedByType[powerup.id] = (gameStats.powerupsUsedByType[powerup.id] || 0) + 1; // Track specific powerup usage
                powerupsUsedThisGame = true; // Mark that a powerup was used this game

                switch (powerup.effect) {
                    case 'speed':
                        gameSpeed = Math.max(50, gameSpeed / 2);
                        powerupActive = { type: 'speed', endTime: Date.now() + actualDuration };
                        showMessage('速度提升已起用！');
                        break;
                    case 'grow':
                        snake.push(snake[snake.length - 1]);
                        showMessage('蛇已成長！');
                        break;
                    case 'clear_obstacles':
                        currentMapObstacles = [];
                        gameStats.obstaclesCleared++; // Track obstacles cleared
                        showMessage('障碍物已清除！');
                        break;
                    case 'slow_motion':
                        gameSpeed = INITIAL_SPEED * 2;
                        powerupActive = { type: 'slow_motion', endTime: Date.now() + actualDuration };
                        showMessage('慢动作已起用！');
                        break;
                    case 'double_score':
                        isDoubleScoreActive = true;
                        if (doubleScoreTimer) clearTimeout(doubleScoreTimer);
                        doubleScoreTimer = setTimeout(() => {
                            isDoubleScoreActive = false;
                            renderPage();
                        }, actualDuration);
                        powerupActive = { type: 'double_score', endTime: Date.now() + actualDuration };
                        showMessage('2倍分数已起用！');
                        break;
                    case 'teleport':
                        const newPos = getRandomGridPosition(snake, foods, currentMapObstacles);
                        if (newPos) {
                            snake[0] = newPos;
                            gameStats.timesTeleported++; // Track teleport usage
                            showMessage('瞬间移动成功！');
                        } else {
                            showMessage('无法找到安全传送位置！');
                        }
                        break;
                    case 'extra_life':
                        extraLives += powerup.value;
                        showMessage(`获得 ${powerup.value} 条额外生命！`);
                        break;
                    case 'multi_food':
                        for (let i = 0; i < powerup.count; i++) {
                            const newFoodPos = getRandomGridPosition(snake, foods, currentMapObstacles);
                            if (newFoodPos) {
                                foods.push(newFoodPos);
                            } else {
                                showMessage('空间不足，无法生成更多食物！'); // Message if multi-food cannot be placed
                            }
                        }
                        showMessage(`生成了 ${powerup.count} 个额外食物！`);
                        break;
                    case 'ghost_mode':
                        isGhostModeActive = true;
                        gameStats.timesGhostModeUsed++; // Track ghost mode usage
                        if (ghostModeTimer) clearTimeout(ghostModeTimer);
                        ghostModeTimer = setTimeout(() => {
                            isGhostModeActive = false;
                            renderPage();
                        }, actualDuration);
                        powerupActive = { type: 'ghost_mode', endTime: Date.now() + actualDuration };
                        showMessage('幽灵模式已起用！');
                        break;
                    case 'shrink_snake':
                        if (snake.length > powerup.value) {
                            snake.splice(snake.length - powerup.value);
                            gameStats.timesShrunkSnake++; // Track shrink usage
                            showMessage(`蛇身缩小 ${powerup.value} ！`);
                        } else if (snake.length > 1) {
                            snake.splice(1);
                            gameStats.timesShrunkSnake++;
                            showMessage('蛇身已缩到最小！');
                        } else {
                            showMessage('蛇身已无法再缩小！');
                        }
                        break;
                    case 'coin_boost':
                        isCoinBoostActive = true;
                        if (coinBoostTimer) clearTimeout(coinBoostTimer);
                        coinBoostTimer = setTimeout(() => {
                            isCoinBoostActive = false;
                            renderPage();
                        }, actualDuration);
                        powerupActive = { type: 'coin_boost', endTime: Date.now() + actualDuration };
                        showMessage('金币加速已起用！');
                        break;
                    case 'super_food':
                        isSuperFoodActive = true;
                        superFoodBonus = { score: powerup.score_bonus, coins: powerup.coin_bonus };
                        showMessage('下一次食物將是Super食物！');
                        break;
                    case 'coin_frenzy': // Exclusive skill
                        // This is a passive effect for a duration, handled in game loop
                        powerupActive = { type: 'coin_frenzy', endTime: Date.now() + actualDuration };
                        showMessage('金币狂熱已开启！');
                        break;
                    case 'map_reveal': // Exclusive skill
                        // This could temporarily highlight food/obstacles
                        // For simplicity, just show a message for now
                        showMessage('地图透视已开启');
                        // No continuous effect, so no powerupActive entry or timer needed unless visual
                        break;
                    default:
                        break;
                }

                // Only remove from purchasedItems if it's a consumable powerup and not an exclusive skill
                if (powerup.category !== 'exclusive_skills') {
                    delete purchasedItems[powerup.id];
                }
                await saveState();
                renderPage();
                await checkAchievements(); // Check for achievements after using powerup
                return true;
            } else {
                showMessage('请先使用此道具！');
                return false;
            }
        }

        // Event Handlers
        function setSnakeDirection(newDir) {
            if (newDir.x === -lastDirection.x && newDir.y === -lastDirection.y) {
                return;
            }
            direction = newDir;
            lastDirection = newDir;

            const activeSkin = getActiveSkin();
            if (activeSkin && activeSkin.skillEffect && activeSkin.skillEffect.type === 'turn_speed_boost') {
                gameSpeed = Math.max(50, gameSpeed + activeSkin.skillEffect.value);
                gameStats.turnSpeedBoostTriggered++; // Track skill usage
                if (turnSpeedBoostTimer) clearTimeout(turnSpeedBoostTimer);
                turnSpeedBoostTimer = setTimeout(() => {
                    gameSpeed = difficulties.find(d => d.id === selectedDifficultyId)?.speed || INITIAL_SPEED;
                    renderPage();
                }, activeSkin.skillEffect.duration);
            }
        }

        function handleKeyDown(e) {
            if (currentPage !== 'game') return;

            let newDirection = { x: 0, y: 0 };

            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    newDirection.y = -1;
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    newDirection.y = 1;
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    newDirection.x = -1;
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    newDirection.x = 1;
                    break;
                default:
                    return;
            }
            setSnakeDirection(newDirection);
        }

        // Joystick Event Handlers
        function handleJoystickStart(e) {
            if (currentPage !== 'game') return;
            joystickActive = true;
            e.preventDefault();
            const touch = e.touches[0];
            const rect = joystickBase.getBoundingClientRect();
            joystickCenterX = rect.left + rect.width / 2;
            joystickCenterY = rect.top + rect.height / 2;
            handleJoystickMove(e);
        }

        function handleJoystickMove(e) {
            if (!joystickActive || currentPage !== 'game') return;
            e.preventDefault();
            const touch = e.touches[0];

            let dx = touch.clientX - joystickCenterX;
            let dy = touch.clientY - joystickCenterY;

            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance > joystickRadius) {
                dx = (dx / distance) * joystickRadius;
                dy = (dy / distance) * joystickRadius;
            }

            joystickStick.style.transform = `translate(${dx}px, ${dy}px)`;

            let newDirection = { x: 0, y: 0 };
            const threshold = joystickRadius * 0.5;

            if (Math.abs(dx) > Math.abs(dy)) {
                if (dx > threshold) {
                    newDirection.x = 1;
                } else if (dx < -threshold) {
                    newDirection.x = -1;
                }
            } else {
                if (dy > threshold) {
                    newDirection.y = 1;
                } else if (dy < -threshold) {
                    newDirection.y = -1;
                }
            }

            if (newDirection.x !== 0 || newDirection.y !== 0) {
                setSnakeDirection(newDirection);
            }
        }

        function handleJoystickEnd(e) {
            joystickActive = false;
            if (joystickStick) {
                joystickStick.style.transform = `translate(0, 0)`;
            }
        }

        // Modal functions
        function showModal(contentHtml, onClose = () => {}) {
            modalContainer.innerHTML = `
                <div class="modal" id="myModal">
                    <div class="modal-content">
                        <span class="close-button" id="closeModalBtn">&times;</span>
                        ${contentHtml}
                    </div>
                </div>
            `;
            const modal = document.getElementById('myModal');
            const closeModalBtn = document.getElementById('closeModalBtn');

            closeModalBtn.onclick = () => {
                modalContainer.innerHTML = '';
                onClose();
            };
            window.onclick = (event) => {
                if (event.target === modal) {
                    modalContainer.innerHTML = '';
                    onClose();
                }
            };
        }

        function renderEmojiPicker() {
            const emojiGridHtml = emojis.map(emoji => `<span class="emoji-item" data-emoji="${emoji}">${emoji}</span>`).join('');
            return `
                <div class="mt-4">
                    <h4 class="text-xl font-bold mb-2">选择头像</h4>
                    <div class="emoji-grid">
                        ${emojiGridHtml}
                    </div>
                </div>
            `;
        }

        function attachEmojiPickerListeners(callback) {
            document.querySelectorAll('.emoji-item').forEach(item => {
                item.onclick = (e) => {
                    selectedAvatar = e.target.dataset.emoji;
                    // Update the displayed selected emoji
                    const selectedEmojiDisplay = document.getElementById('selected-emoji-display');
                    if (selectedEmojiDisplay) {
                        selectedEmojiDisplay.textContent = selectedAvatar;
                    }
                    callback(selectedAvatar);
                };
            });
        }

        async function fetchLeaderboard() {
            const usersRef = collection(db, `artifacts/${appId}/public/data/users_public_profiles`);
            // Order by level descending, then by xp descending
            const q = query(usersRef, orderBy("level", "desc"), orderBy("xp", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            const leaderboardData = [];
            querySnapshot.forEach((doc) => {
                leaderboardData.push(doc.data());
            });
            return leaderboardData;
        }

        // Page Rendering Function
        function renderPage() {
            appRoot.innerHTML = '';
            let contentHtml = '';

            if (currentPage === 'auth') {
                contentHtml = `
                    <div class="flex flex-col items-center justify-center h-full w-full text-white p-4">
                        <h2 class="text-5xl font-extrabold mb-8 text-yellow-400 drop-shadow-lg"贪吃蛇</h2>
                        <div class="bg-gray-800 rounded-lg p-8 shadow-xl w-full max-w-md">
                            <h3 class="text-3xl font-bold mb-6 text-center">登入</h3>

                            <div class="mb-4">
                                <label for="auth-email" class="block text-lg font-medium mb-2">邮件:</label>
                                <input type="email" id="auth-email" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入您的邮件">
                            </div>
                            <div class="mb-6">
                                <label for="auth-password" class="block text-lg font-medium mb-2">密码:</label>
                                <input type="password" id="auth-password" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入您的密码">
                            </div>

                            <button id="login-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 w-full">
                                登入
                            </button>

                            <div class="mt-6 text-center">
                                <a href="#" id="register-link" class="text-blue-400 hover:underline text-lg">还没注册吗？马上注册</a>
                            </div>
                            <div class="mt-4 text-center">
                                <a href="#" id="guest-mode-link" class="text-green-400 hover:underline text-lg">访客模式</a>
                            </div>
                        </div>
                        ${message ? `<div class="absolute bottom-4 bg-red-500 text-white text-lg px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in-out">${message}</div>` : ''}
                    </div>
                `;
            } else if (currentPage === 'register') {
                 contentHtml = `
                    <div class="flex flex-col items-center justify-center h-full w-full text-white p-4">
                        <h2 class="text-5xl font-extrabold mb-8 text-yellow-400 drop-shadow-lg">注册账号</h2>
                        <div class="bg-gray-800 rounded-lg p-8 shadow-xl w-full max-w-md">
                            <div class="mb-4">
                                <label for="reg-nickname" class="block text-lg font-medium mb-2">昵称:</label>
                                <input type="text" id="reg-nickname" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="輸入您的昵称">
                            </div>

                            <div class="mb-6">
                                <label class="block text-lg font-medium mb-2">头像:</label>
                                <div class="flex items-center justify-center space-x-4">
                                    <span id="selected-emoji-display" class="text-5xl cursor-pointer p-2 rounded-full border-2 border-gray-600 hover:border-blue-500 transition-colors">${selectedAvatar}</span>
                                </div>
                                <div id="emoji-picker-container" class="mt-4 hidden">
                                    ${renderEmojiPicker()}
                                </div>
                            </div>

                            <button id="toggle-emoji-picker" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mb-4 w-full">
                                选择头像
                            </button>

                            <div class="mb-4">
                                <label for="reg-email" class="block text-lg font-medium mb-2">邮箱:</label>
                                <input type="email" id="reg-email" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入您的邮件">
                            </div>
                            <div class="mb-6">
                                <label for="reg-password" class="block text-lg font-medium mb-2">密码:</label>
                                <input type="password" id="reg-password" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入您的密码">
                            </div>

                            <button id="register-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mb-4 w-full">
                                注册
                            </button>
                            <div class="mt-6 text-center">
                                <a href="#" id="back-to-login-link" class="text-gray-400 hover:underline text-lg">返回登入</a>
                            </div>
                        </div>
                        ${message ? `<div class="absolute bottom-4 bg-red-500 text-white text-lg px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in-out">${message}</div>` : ''}
                    </div>
                `;
            } else if (currentPage === 'guestSetup') {
                contentHtml = `
                    <div class="flex flex-col items-center justify-center h-full w-full text-white p-4">
                        <h2 class="text-5xl font-extrabold mb-8 text-yellow-400 drop-shadow-lg">访客模式</h2>
                        <div class="bg-gray-800 rounded-lg p-8 shadow-xl w-full max-w-md">
                            <div class="mb-4">
                                <label for="guest-nickname" class="block text-lg font-medium mb-2">昵称:</label>
                                <input type="text" id="guest-nickname" class="w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="輸入您的昵称">
                            </div>

                            <div class="mb-6">
                                <label class="block text-lg font-medium mb-2">头像:</label>
                                <div class="flex items-center justify-center space-x-4">
                                    <span id="selected-emoji-display" class="text-5xl cursor-pointer p-2 rounded-full border-2 border-gray-600 hover:border-blue-500 transition-colors">${selectedAvatar}</span>
                                </div>
                                <div id="emoji-picker-container" class="mt-4 hidden">
                                    ${renderEmojiPicker()}
                                </div>
                            </div>

                            <button id="toggle-emoji-picker" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mb-4 w-full">
                                选择头像
                            </button>

                            <button id="guest-login-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mb-4 w-full">
                                以访客身份游玩
                            </button>
                            <div class="mt-6 text-center">
                                <a href="#" id="back-to-login-link" class="text-gray-400 hover:underline text-lg">返回登入</a>
                            </div>
                        </div>
                        ${message ? `<div class="absolute bottom-4 bg-red-500 text-white text-lg px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in-out">${message}</div>` : ''}
                    </div>
                `;
            }
            else if (currentPage === 'intro') {
                contentHtml = `
                    <div class="relative w-full h-screen bg-gray-900 flex items-center justify-center overflow-hidden">
                        <div class="absolute left-[-100%] intro-snake" style="width: 100px; height: 50px; background-color: transparent; border-radius: 9999px;">
                            <span class="text-6xl absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">🐍</span>
                        </div>
                        <div class="absolute inset-0 bg-white" id="intro-light-overlay"></div>
                    </div>
                `;
            } else if (currentPage === 'home') {
                contentHtml = `
                    <div class="relative flex flex-col items-center justify-center h-full w-full">
                        <h1 class="text-5xl font-extrabold text-white mb-8 drop-shadow-lg animate-bounce">贪吃蛇</h1>
                        <button id="start-game-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mb-4">
                            开始
                        </button>
                        <button id="shop-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mb-4">
                            商店
                        </button>
                        <button id="achievements-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105">
                            成就
                        </button>
                        <div class="absolute top-4 left-4 text-white text-xl flex items-center">
                            <button id="profile-menu-btn" class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-700 transition-colors">
                                <span class="text-4xl">${userProfile.avatar}</span>
                                <div class="flex flex-col items-start">
                                    <span>${userProfile.displayName}</span>
                                    <span>等级: ${level}</span>
                                    <div class="relative w-32 h-3 bg-gray-700 rounded-full mt-1 overflow-hidden group">
                                        <div class="absolute h-full bg-blue-500 rounded-full" style="width: ${((xp % XP_PER_LEVEL) / XP_PER_LEVEL) * 100}%;"></div>
                                        <div class="absolute inset-0 flex items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                            ${xp % XP_PER_LEVEL} / ${XP_PER_LEVEL} XP
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        <div class="absolute top-4 right-4 text-white text-xl">
                            <span>金币: ${coins}</span>
                        </div>
                    </div>
                `;
            } else if (currentPage === 'difficultySelect') {
                const unlockedDifficulties = difficulties.filter(diff => purchasedItems[`unlock_${diff.id}`]);
                let difficultyButtonsHtml = '';
                if (unlockedDifficulties.length > 0) {
                    difficultyButtonsHtml = unlockedDifficulties.map(diff => `
                        <button id="difficulty-${diff.id}" class="py-3 px-6 rounded-full font-bold shadow-md transition duration-300 mb-4 w-64 bg-purple-600 hover:bg-purple-700 text-white">
                            ${diff.name}
                        </button>
                    `).join('');
                } else {
                    difficultyButtonsHtml = `<p class="text-xl text-gray-400 mb-4">请前往商店解锁难度！</p>`;
                }
                contentHtml = `
                    <div class="flex flex-col items-center justify-center h-full text-white">
                        <h2 class="text-4xl font-extrabold mb-8 text-yellow-400">选择难度</h2>
                        ${difficultyButtonsHtml}
                        <button id="back-to-home-from-difficulty" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105">
                            返回主页
                        </button>
                        ${message ? `<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-lg px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in-out">${message}</div>` : ''}
                    </div>
                `;
            } else if (currentPage === 'mapSelect') {
                const unlockedMaps = maps.filter(map => purchasedItems[`unlock_${map.id}`]);
                let mapButtonsHtml = '';
                if (unlockedMaps.length > 0) {
                    mapButtonsHtml = unlockedMaps.map(map => `
                        <button id="map-${map.id}" class="py-3 px-6 rounded-full font-bold shadow-md transition duration-300 mb-4 w-64 bg-green-600 hover:bg-green-700 text-white">
                            ${map.name}
                        </button>
                    `).join('');
                } else {
                    mapButtonsHtml = `<p class="text-xl text-gray-400 mb-4">请前往商店解锁地图！</p>`;
                }
                contentHtml = `
                    <div class="flex flex-col items-center justify-center h-full text-white">
                        <h2 class="text-4xl font-extrabold mb-8 text-yellow-400">选择地图</h2>
                        ${mapButtonsHtml}
                        <button id="back-to-difficulty-from-map" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105">
                            返回难度选择
                        </button>
                        ${message ? `<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-lg px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in-out">${message}</div>` : ''}
                    </div>
                `;
            } else if (currentPage === 'skinSelect') {
                const ownedSkins = shopItemsData.filter(item => item.type === 'skin' && (purchasedItems[item.id] || unlockedExclusiveRewards[item.id]));
                let skinButtonsHtml = '';
                if (ownedSkins.length > 0) {
                    skinButtonsHtml = ownedSkins.map(skin => `
                        <div class="bg-gray-800 rounded-lg p-4 shadow-xl flex flex-col items-center transform transition duration-300 hover:scale-105 ${activeSkinId === skin.id ? 'border-4 border-green-500' : ''}">
                            <h3 class="text-2xl font-bold mb-2 text-center">${skin.name}</h3>
                            <div class="w-20 h-20 rounded-full mb-2 border-2 border-gray-600 flex items-center justify-center" style="background-color: ${skin.color.includes('gradient') ? skin.color : skin.color}; ${skin.color.includes('gradient') ? 'background-image: ' + skin.color + ';' : ''}">
                                <span class="text-4xl">🐍</span>
                            </div>
                            <p class="text-gray-400 text-center text-sm mb-2">技能: ${skin.skill}</p>
                            <button id="select-skin-${skin.id}" class="py-2 px-4 rounded-full font-bold shadow-md transition duration-300 ${activeSkinId === skin.id ? 'bg-green-500 text-white cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-700 text-white'}" ${activeSkinId === skin.id ? 'disabled' : ''}>
                                ${activeSkinId === skin.id ? '已启用' : '选择'}
                            </button>
                        </div>
                    `).join('');
                } else {
                    skinButtonsHtml = `<p class="text-xl text-gray-400 mb-4">你没有可用的蛇皮。请前往商店购买！</p>`;
                }

                contentHtml = `
                    <div class="flex flex-col items-center justify-center h-full text-white p-4">
                        <h2 class="text-4xl font-extrabold mb-8 text-yellow-400">选择蛇皮</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 w-full max-w-2xl scrollable-content-container">
                            ${skinButtonsHtml}
                        </div>
                        <button id="proceed-to-powerup-select" class="mt-8 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105">
                            蛇皮 (目前蛇皮: ${getActiveSkin()?.name})
                        </button>
                        <button id="back-to-map-from-skin" class="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105">
                            返回地图选择
                        </button>
                        ${message ? `<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-lg px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in-out">${message}</div>` : ''}
                    </div>
                `;
            }
            else if (currentPage === 'powerupSelect') {
                // Filter powerups that are either purchased or are exclusive rewards that are unlocked
                const availablePowerupsPreGame = shopItemsData.filter(item =>
                    item.type === 'powerup' && (purchasedItems[item.id] || unlockedExclusiveRewards[item.id])
                );
                const ownedSkinsCount = shopItemsData.filter(item => item.type === 'skin' && (purchasedItems[item.id] || unlockedExclusiveRewards[item.id])).length;

                let powerupButtonsHtml = '';
                if (availablePowerupsPreGame.length > 0) {
                    powerupButtonsHtml = availablePowerupsPreGame.map(powerup => `
                        <button id="powerup-pregame-${powerup.id}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mb-4 w-64">
                            使用 ${powerup.name}
                        </button>
                    `).join('');
                    powerupButtonsHtml += `
                        <button id="no-powerup-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mt-4 w-64">
                            不使用道具
                        </button>
                    `;
                } else {
                    powerupButtonsHtml = `
                        <p class="text-xl text-gray-400 mb-4">你没有可用的道具。请前往商店购买！</p>
                        <button id="start-game-anyway-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mt-4 w-64">
                            直接开始游戏
                        </button>
                    `;
                }

                const backButtonId = ownedSkinsCount <= 1 ? "back-to-map-from-powerup" : "back-to-skin-from-powerup";
                const backButtonText = ownedSkinsCount <= 1 ? "返回地图选择" : "返回蛇皮选择";

                contentHtml = `
                    <div class="flex flex-col items-center justify-center h-full text-white">
                        <h2 class="text-4xl font-extrabold mb-8 text-yellow-400">选择道具 (游戏开始前)</h2>
                        ${powerupButtonsHtml}
                        <button id="${backButtonId}" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105">
                            ${backButtonText}
                        </button>
                        ${message ? `<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-lg px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in-out">${message}</div>` : ''}
                    </div>
                `;
            } else if (currentPage === 'game') {
                const currentMapData = maps.find(map => map.id === selectedMapId);
                const snakeColor = getActiveSkin()?.color || '#3B82F6';

                // Calculate dynamic GRID_SIZE based on screen size
                const maxBoardWidth = window.innerWidth * 0.9; // 90% of screen width
                const maxBoardHeight = window.innerHeight * 0.7; // 70% of screen height
                const boardDimension = Math.min(maxBoardWidth, maxBoardHeight);
                const dynamicGridSize = Math.floor(boardDimension / BOARD_WIDTH_CELLS);
                const actualBoardWidthPx = dynamicGridSize * BOARD_WIDTH_CELLS;
                const actualBoardHeightPx = dynamicGridSize * BOARD_HEIGHT_CELLS;

                let snakeSegmentsHtml = snake.map((segment, index) => `
                    <div class="absolute rounded-sm" style="left: ${segment.x * dynamicGridSize}px; top: ${segment.y * dynamicGridSize}px; width: ${dynamicGridSize}px; height: ${dynamicGridSize}px; background-color: ${snakeColor}; border: 1px solid rgba(0,0,0,0.2); transition: left ${gameSpeed / 1000}s linear, top ${gameSpeed / 1000}s linear; opacity: ${invincibilityActive ? 0.5 : 1};"></div>
                `).join('');

                let obstaclesHtml = currentMapObstacles.map((obstacle, index) => `
                    <div class="absolute rounded-sm" style="left: ${obstacle.x * dynamicGridSize}px; top: ${obstacle.y * dynamicGridSize}px; width: ${dynamicGridSize}px; height: ${dynamicGridSize}px; background-color: ${currentMapData.obstacleColor};"></div>
                `).join('');

                const availablePowerupsInGame = shopItemsData.filter(item => item.type === 'powerup' && (purchasedItems[item.id] || unlockedExclusiveRewards[item.id]));
                let inGamePowerupsHtml = '';
                if (availablePowerupsInGame.length > 0) {
                    inGamePowerupsHtml = `
                        <div class="mt-6 flex flex-wrap justify-center gap-4">
                            ${availablePowerupsInGame.map(powerup => `
                                <button id="powerup-ingame-${powerup.id}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transform transition duration-300 hover:scale-105 ${powerupActive && powerupActive.type === powerup.effect ? 'opacity-50 cursor-not-allowed' : ''}" ${powerupActive && powerupActive.type === powerup.effect ? 'disabled' : ''}>
                                    使用 ${powerup.name}
                                </button>
                            `).join('')}
                        </div>
                    `;
                }

                contentHtml = `
                    <div class="flex flex-col items-center justify-center w-full h-full p-4" id="game-container">
                        <div class="flex justify-between w-full max-w-2xl px-4 py-2 text-white text-lg font-bold">
                            <div class="bg-black bg-opacity-60 rounded-lg p-2 px-4">
                                <span>分数: ${score}</span>
                            </div>
                            <div class="bg-black bg-opacity-60 rounded-lg p-2 px-4">
                                <span>金币: ${coins}</span>
                            </div>
                        </div>
                        <div class="relative border-4 border-gray-700 rounded-lg overflow-hidden shadow-2xl" style="width: ${actualBoardWidthPx}px; height: ${actualBoardHeightPx}px; background-color: ${currentMapData.backgroundColor};">
                            ${currentShield > 0 ? `<div class="absolute top-4 left-1/2 -translate-x-1/2 text-blue-400 text-xl font-bold bg-black bg-opacity-60 rounded-lg p-2 px-4 z-10">護盾: ${currentShield}</div>` : ''}
                            ${extraLives > 0 ? `<div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-red-400 text-xl font-bold bg-black bg-opacity-60 rounded-lg p-2 px-4 z-10">生命: ${extraLives}</div>` : ''}
                            ${obstaclesHtml}
                            ${snakeSegmentsHtml}
                            ${foods.map((f, index) => `
                                <div key="${index}" class="absolute bg-yellow-400 rounded-full flex items-center justify-center text-black font-bold text-lg" style="left: ${f.x * dynamicGridSize}px; top: ${f.y * dynamicGridSize}px; width: ${dynamicGridSize}px; height: ${dynamicGridSize}px; transform: scale(0.8); animation: pulse ${foodBlinkSpeed}s infinite;">
                                    $
                                </div>
                            `).join('')}
                        </div>
                        ${message ? `<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-yellow-500 text-white text-lg px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in-out">${message}</div>` : ''}
                        ${powerupActive ? `<div class="mt-4 text-white text-lg bg-purple-600 px-4 py-2 rounded-lg">道具起用中: ${shopItemsData.find(item => item.effect === powerupActive.type)?.name || exclusiveRewards[powerupActive.type]?.name || powerupActive.type}</div>` : ''}
                        ${inGamePowerupsHtml}
                        <div class="mt-6 md:hidden flex justify-center w-full">
                            <div id="joystick-base" class="joystick-base">
                                <div id="joystick-stick" class="joystick-stick"></div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentPage === 'gameOver') {
                contentHtml = `
                    <div class="flex flex-col items-center justify-center h-full text-white">
                        <h2 class="text-6xl font-extrabold mb-6 text-red-500 drop-shadow-lg animate-fade-in">游戏结束！</h2>
                        <p class="text-3xl mb-4">最终分数: ${score}</p>
                        <p class="text-3xl mb-8">本局获得金币: ${lastGameCoins}</p>
                        <button id="restart-game-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mb-4">
                            重新开始
                        </button>
                        <button id="go-to-shop-from-gameover" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mb-4">
                            前往商店
                        </button>
                        <button id="back-to-home-from-gameover" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105">
                            返回主页
                        </button>
                    </div>
                `;
            } else if (currentPage === 'shop') {
                let shopItemsHtml = '';
                let itemsToDisplay = [];

                if (shopCategory === 'skins' || shopCategory === 'powerups') {
                    itemsToDisplay = shopItemsData.filter(item => item.category === shopCategory);
                } else if (shopCategory === 'difficulties') {
                    itemsToDisplay = difficulties.map(diff => ({
                        id: `unlock_${diff.id}`,
                        name: diff.name,
                        price: diff.price,
                        type: 'unlock_difficulty',
                        description: `解锁 ${diff.name} 难度`,
                        isUnlocked: purchasedItems[`unlock_${diff.id}`],
                    }));
                } else if (shopCategory === 'maps') {
                    itemsToDisplay = maps.map(map => ({
                        id: `unlock_${map.id}`,
                        name: map.name,
                        price: map.price,
                        type: 'unlock_map',
                        description: `解锁 ${map.name} 地图`,
                        isUnlocked: purchasedItems[`unlock_${map.id}`],
                    }));
                }

                shopItemsHtml = itemsToDisplay.map(item => {
                    const isPurchased = purchasedItems[item.id] || unlockedExclusiveRewards[item.id];
                    const isActiveSkin = item.type === 'skin' && activeSkinId === item.id;

                    let buttonText;
                    let buttonClass;
                    let isDisabled;

                    if (item.type === 'skin') {
                        if (isActiveSkin) {
                            buttonText = '已起用';
                            buttonClass = 'bg-green-500 text-white cursor-not-allowed';
                            isDisabled = true;
                        } else if (isPurchased) {
                            buttonText = '已拥有';
                            buttonClass = 'bg-gray-500 text-white cursor-not-allowed';
                            isDisabled = true;
                        } else {
                            buttonText = '购买';
                            buttonClass = 'bg-purple-600 hover:bg-purple-700 text-white';
                            isDisabled = false;
                        }
                    } else { // For powerups, difficulties, maps
                        if (isPurchased) {
                            buttonText = '已拥有';
                            buttonClass = 'bg-gray-500 text-white cursor-not-allowed';
                            isDisabled = true;
                        } else {
                            buttonText = '购买';
                            buttonClass = 'bg-blue-600 hover:bg-blue-700 text-white';
                            isDisabled = false;
                        }
                    }

                    const priceDisplay = item.price === 0 ? '免费' : `${item.price} 金币`;
                    const itemDescription = item.type === 'skin' ? `技能: ${item.skill}` : item.description; // Use item.description for unlockables

                    return `
                        <div class="bg-gray-800 rounded-lg p-6 shadow-xl flex flex-col items-center transform transition duration-300 hover:scale-105">
                            <h3 class="text-2xl font-bold mb-2 text-center">${item.name}</h3>
                            ${item.type === 'skin' ? `
                                <div class="w-24 h-24 rounded-full mb-4 border-4 border-gray-600 flex items-center justify-center" style="background-color: ${item.color.includes('gradient') ? item.color : item.color}; ${item.color.includes('gradient') ? 'background-image: ' + item.color + ';' : ''}">
                                    <span class="text-5xl">🐍</span>
                                </div>
                                <p class="text-gray-400 text-center mb-2">${itemDescription}</p>
                            ` : `
                                <p class="text-gray-400 text-center mb-4">${itemDescription}</p>
                            `}
                            <p class="text-xl font-semibold mb-4">价格: ${priceDisplay}</p>
                            <button id="shop-item-${item.id}" class="py-3 px-6 rounded-full font-bold shadow-md transition duration-300 ${buttonClass}" ${isDisabled ? 'disabled' : ''}>
                                ${buttonText}
                            </button>
                        </div>
                    `;
                }).join('');

                contentHtml = `
                    <div class="flex flex-col items-center h-full w-full bg-gray-900 text-white p-4">
                        <h2 class="text-5xl font-extrabold mb-4 text-yellow-400 drop-shadow-lg">商店</h2>
                        <p class="text-3xl mb-4">您的金币: ${coins}</p>

                        ${message ? `<div class="bg-yellow-500 text-white text-lg px-4 py-2 rounded-lg shadow-lg mb-4 animate-fade-in-out">${message}</div>` : ''}

                        <div class="flex justify-center gap-4 mb-4 flex-wrap">
                            <button id="shop-category-skins" class="py-2 px-6 rounded-full font-bold transition duration-300 ${shopCategory === 'skins' ? 'bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white">
                                蛇皮
                            </button>
                            <button id="shop-category-powerups" class="py-2 px-6 rounded-full font-bold transition duration-300 ${shopCategory === 'powerups' ? 'bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white">
                                道具
                            </button>
                            <button id="shop-category-difficulties" class="py-2 px-6 rounded-full font-bold transition duration-300 ${shopCategory === 'difficulties' ? 'bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white">
                                难度
                            </button>
                            <button id="shop-category-maps" class="py-2 px-6 rounded-full font-bold transition duration-300 ${shopCategory === 'maps' ? 'bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white">
                                地图
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-4xl scrollable-content-container">
                            ${shopItemsHtml}
                        </div>

                        <button id="back-to-home-from-shop" class="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105">
                            返回主页
                        </button>
                    </div>
                `;
            } else if (currentPage === 'achievements') {
                const filteredAchievements = allAchievements.filter(ach => ach.category === achievementCategory);
                let achievementsHtml = filteredAchievements.map(ach => {
                    const isCompleted = completedAchievements[ach.id];
                    return `
                        <div class="bg-gray-800 rounded-lg p-6 shadow-xl flex flex-col items-center transform transition duration-300 hover:scale-105 ${isCompleted ? 'border-l-4 border-green-500' : 'border-l-4 border-gray-600'}">
                            <h3 class="text-2xl font-bold mb-2 text-center ${isCompleted ? 'text-green-300' : 'text-white'}">${ach.name} ${isCompleted ? '✅' : '❌'}</h3>
                            <p class="text-gray-400 text-center mb-2">${ach.description}</p>
                            <p class="text-yellow-400 text-xl font-semibold mb-2">奖励: ${ach.reward} 金币</p>
                            <p class="text-blue-400 text-xl font-semibold">经验值: ${ach.xpReward}</p>
                        </div>
                    `;
                }).join('');

                let categoryButtonsHtml = achievementCategories.map(category => `
                    <button id="achievement-category-${category.id}" class="py-2 px-6 rounded-full font-bold transition duration-300 ${achievementCategory === category.id ? 'bg-blue-700' : 'bg-blue-500 hover:bg-blue-600'} text-white">
                        ${category.name}
                    </button>
                `).join('');

                contentHtml = `
                    <div class="flex flex-col items-center h-full w-full bg-gray-900 text-white p-4">
                        <h2 class="text-5xl font-extrabold mb-4 text-yellow-400 drop-shadow-lg">成就</h2>
                        <p class="text-2xl mb-2">已完成: ${Object.keys(completedAchievements).length} / ${allAchievements.length}</p>
                        <div class="text-white text-xl flex flex-col items-center mb-4">
                            <span>经验值: ${xp} / ${level * XP_PER_LEVEL}</span>
                            <span>等级: ${level}</span>
                        </div>

                        <div class="flex justify-center gap-4 mb-4 flex-wrap">
                            ${categoryButtonsHtml}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-4xl scrollable-content-container">
                            ${achievementsHtml}
                        </div>

                        <button id="back-to-home-from-achievements" class="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105">
                            返回主页
                        </button>
                    </div>
                `;
            } else if (currentPage === 'leaderboard') {
                contentHtml = `
                    <div class="flex flex-col items-center h-full w-full bg-gray-900 text-white p-4">
                        <h2 class="text-5xl font-extrabold mb-8 text-yellow-400 drop-shadow-lg">排行榜</h2>
                        <div id="leaderboard-list" class="w-full max-w-2xl bg-gray-800 rounded-lg shadow-xl p-6 scrollable-content-container">
                            <p class="text-center text-gray-400">加载中...</p>
                        </div>
                        <button id="back-to-home-from-leaderboard" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105">
                            返回主页
                        </button>
                    </div>
                `;
                // Fetch and render leaderboard data after the page is rendered
                setTimeout(async () => {
                    const leaderboardListDiv = document.getElementById('leaderboard-list');
                    if (leaderboardListDiv) {
                        const leaderboardData = await fetchLeaderboard();
                        let listHtml = '';
                        if (leaderboardData.length > 0) {
                            listHtml = `
                                <div class="grid grid-cols-3 gap-4 text-lg font-bold border-b-2 border-gray-700 pb-2 mb-4">
                                    <span>头像</span>
                                    <span>昵称</span>
                                    <span>等级(XP)</span>
                                </div>
                            `;
                            leaderboardData.forEach((player, index) => {
                                listHtml += `
                                    <div class="grid grid-cols-3 gap-4 py-2 border-b border-gray-700 items-center">
                                        <span class="text-3xl">${player.avatar || '😀'}</span>
                                        <span>${player.displayName || '匿名玩家'}</span>
                                        <span>等级 ${player.level || 1} (${player.xp || 0} XP)</span>
                                    </div>
                                `;
                            });
                        } else {
                            listHtml = '<p class="text-center text-gray-400">目前沒有排名榜。</p>';
                        }
                        leaderboardListDiv.innerHTML = listHtml;
                    }
                }, 100); // Small delay to ensure DOM is ready
            }


            appRoot.innerHTML = contentHtml;
            attachEventListeners();
        }

        // Attach Event Listeners (needs to be called after each render that adds new buttons)
        function attachEventListeners() {
            // Auth Page
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) loginBtn.onclick = async () => {
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;

                if (!email || !password) {
                    showMessage('请输入邮箱和密码！');
                    return;
                }

                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    currentUserId = userCredential.user.uid;
                    isGuestUser = false;
                    await loadState(); // Load existing data for logged-in user
                    showMessage('登入成功！');
                    currentPage = 'home';
                    renderPage();
                } catch (error) {
                    showMessage(`登入失败: ${error.message}`);
                    console.error("Login error:", error);
                }
            };

            const registerLink = document.getElementById('register-link');
            if (registerLink) registerLink.onclick = (e) => {
                e.preventDefault();
                currentPage = 'register';
                renderPage();
            };

            const guestModeLink = document.getElementById('guest-mode-link');
            if (guestModeLink) guestModeLink.onclick = (e) => {
                e.preventDefault();
                currentPage = 'guestSetup';
                renderPage();
            };

            // Register Page
            const regNicknameInput = document.getElementById('reg-nickname');
            if (regNicknameInput) {
                regNicknameInput.oninput = (e) => {
                    userProfile.displayName = e.target.value;
                };
            }

            const registerBtn = document.getElementById('register-btn');
            if (registerBtn) registerBtn.onclick = async () => {
                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                const nickname = document.getElementById('reg-nickname').value;

                if (!email || !password || !nickname) {
                    showMessage('请填满所以槽位');
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    currentUserId = userCredential.user.uid;
                    isGuestUser = false;
                    userProfile.displayName = nickname;
                    userProfile.avatar = selectedAvatar;
                    userProfile.level = 1;
                    userProfile.xp = 0;
                    coins = 0; // Reset for new registered user
                    xp = 0;
                    level = 1;
                    purchasedItems = {}; // Reset purchased items
                    gameStats = {}; // Reset game stats
                    completedAchievements = {}; // Reset achievements
                    unlockedExclusiveRewards = {}; // Reset exclusive rewards

                    // Ensure default items are set for new registered user
                    shopItemsData.forEach(item => { if (item.default) purchasedItems[item.id] = true; });
                    difficulties.forEach(diff => { if (diff.default) purchasedItems[`unlock_${diff.id}`] = true; });
                    maps.forEach(map => { if (map.default) purchasedItems[`unlock_${map.id}`] = true; });

                    await saveState(); // Save initial state for new user
                    showMessage('注册成功！');
                    currentPage = 'home';
                    renderPage();
                } catch (error) {
                    showMessage(`注册失败: ${error.message}`);
                    console.error("Registration error:", error);
                }
            };

            // Guest Setup Page
            const guestNicknameInput = document.getElementById('guest-nickname');
            if (guestNicknameInput) {
                guestNicknameInput.oninput = (e) => {
                    userProfile.displayName = e.target.value;
                };
            }

            const guestLoginBtn = document.getElementById('guest-login-btn');
            if (guestLoginBtn) guestLoginBtn.onclick = async () => {
                const nickname = document.getElementById('guest-nickname').value;
                if (!nickname) {
                    showMessage('请输入昵称！');
                    return;
                }
                userProfile.displayName = nickname;
                userProfile.avatar = selectedAvatar;
                isGuestUser = true;
                currentUserId = `guest_${crypto.randomUUID()}`; // Generate a unique guest ID
                await loadState(); // Load guest data if exists
                currentPage = 'home';
                renderPage();
            };

            // Common for Register and Guest Setup
            const toggleEmojiPickerBtns = document.querySelectorAll('#toggle-emoji-picker');
            toggleEmojiPickerBtns.forEach(btn => {
                btn.onclick = () => {
                    const emojiPickerContainer = document.getElementById('emoji-picker-container');
                    if (emojiPickerContainer) {
                        emojiPickerContainer.classList.toggle('hidden');
                        attachEmojiPickerListeners(() => {
                            // Hide picker after selection
                            emojiPickerContainer.classList.add('hidden');
                        });
                    }
                };
            });

            const selectedEmojiDisplays = document.querySelectorAll('#selected-emoji-display');
            selectedEmojiDisplays.forEach(display => {
                display.onclick = () => {
                    const emojiPickerContainer = document.getElementById('emoji-picker-container');
                    if (emojiPickerContainer) {
                        emojiPickerContainer.classList.toggle('hidden');
                        attachEmojiPickerListeners(() => {
                            emojiPickerContainer.classList.add('hidden');
                        });
                    }
                };
            });

            const backToLoginLinks = document.querySelectorAll('#back-to-login-link');
            backToLoginLinks.forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    currentPage = 'auth';
                    renderPage();
                };
            });

            // Home Page
            const startGameBtn = document.getElementById('start-game-btn');
            if (startGameBtn) startGameBtn.onclick = () => { currentPage = 'difficultySelect'; renderPage(); };
            const shopBtn = document.getElementById('shop-btn');
            if (shopBtn) shopBtn.onclick = () => { currentPage = 'shop'; renderPage(); };
            const achievementsBtn = document.getElementById('achievements-btn');
            if (achievementsBtn) achievementsBtn.onclick = () => { currentPage = 'achievements'; renderPage(); };

            const profileMenuBtn = document.getElementById('profile-menu-btn');
            if (profileMenuBtn) profileMenuBtn.onclick = () => {
                showModal(`
                    <h3 class="text-3xl font-bold mb-6">玩家设置</h3>
                    <button id="show-leaderboard-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 mb-4 w-full">
                        排行榜
                    </button>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 w-full">
                        登出
                    </button>
                `, () => { /* No specific action on close */ });

                // Attach listeners for modal buttons
                const showLeaderboardBtn = document.getElementById('show-leaderboard-btn');
                if (showLeaderboardBtn) showLeaderboardBtn.onclick = () => {
                    modalContainer.innerHTML = ''; // Close modal
                    currentPage = 'leaderboard';
                    renderPage();
                };

                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) logoutBtn.onclick = async () => {
                    try {
                        if (!isGuestUser) {
                            await signOut(auth);
                        }
                        // Clear local storage for guest or reset for logged out user
                        localStorage.removeItem('guestGameData');
                        localStorage.removeItem('guestProfile');
                        currentUserId = null;
                        isGuestUser = false;
                        userProfile = { displayName: 'Guest', avatar: '😀', level: 1, xp: 0 };
                        selectedAvatar = '😀'; // Reset selected avatar for next login
                        // Reset game state to defaults for a fresh start
                        coins = 0; xp = 0; level = 1; purchasedItems = {}; gameStats = {};
                        completedAchievements = {}; unlockedExclusiveRewards = {}; activeSkinId = 'skin_blue';
                        shopItemsData.forEach(item => { if (item.default) purchasedItems[item.id] = true; });
                        difficulties.forEach(diff => { if (diff.default) purchasedItems[`unlock_${diff.id}`] = true; });
                        maps.forEach(map => { if (map.default) purchasedItems[`unlock_${map.id}`] = true; });

                        modalContainer.innerHTML = ''; // Close modal
                        showMessage('已登出！');
                        currentPage = 'auth'; // Go back to auth page
                        renderPage();
                    } catch (error) {
                        showMessage(`登出失败: ${error.message}`);
                        console.error("Logout error:", error);
                    }
                };
            };


            // Difficulty Select Page
            difficulties.forEach(diff => {
                const btn = document.getElementById(`difficulty-${diff.id}`);
                if (btn) btn.onclick = () => {
                    if (purchasedItems[`unlock_${diff.id}`]) {
                        selectedDifficultyId = diff.id;
                        currentPage = 'mapSelect';
                        renderPage();
                    } else {
                        showMessage(`请先在商店购买 '${diff.name}' 难度！`);
                    }
                };
            });
            const backToHomeFromDifficultyBtn = document.getElementById('back-to-home-from-difficulty');
            if (backToHomeFromDifficultyBtn) backToHomeFromDifficultyBtn.onclick = () => { currentPage = 'home'; renderPage(); };

            // Map Select Page
            maps.forEach(map => {
                const btn = document.getElementById(`map-${map.id}`);
                if (btn) btn.onclick = () => {
                    if (purchasedItems[`unlock_${map.id}`]) {
                        selectedMapId = map.id;
                        const ownedSkins = shopItemsData.filter(item => item.type === 'skin' && (purchasedItems[item.id] || unlockedExclusiveRewards[item.id]));
                        if (ownedSkins.length <= 1) { // If only default skin or no skins owned
                            activeSkinId = ownedSkins[0]?.id || 'skin_blue'; // Ensure a skin is active
                            currentPage = 'powerupSelect';
                        } else {
                            currentPage = 'skinSelect';
                        }
                        renderPage();
                    } else {
                        showMessage(`请先在商店购买 '${map.name}' 地图！`);
                    }
                };
            });
            const backToDifficultyFromMapBtn = document.getElementById('back-to-difficulty-from-map');
            if (backToDifficultyFromMapBtn) backToDifficultyFromMapBtn.onclick = () => { currentPage = 'difficultySelect'; renderPage(); };

            // Skin Select Page
            const ownedSkins = shopItemsData.filter(item => item.type === 'skin' && (purchasedItems[item.id] || unlockedExclusiveRewards[item.id]));
            ownedSkins.forEach(skin => {
                const btn = document.getElementById(`select-skin-${skin.id}`);
                if (btn) btn.onclick = async () => { // Made async
                    await activateSkin(skin.id);
                    // No immediate page change here, user can still change skin.
                    // The "繼續" button will handle the transition to powerupSelect.
                };
            });
            const proceedToPowerupSelectBtn = document.getElementById('proceed-to-powerup-select');
            if (proceedToPowerupSelectBtn) proceedToPowerupSelectBtn.onclick = () => { currentPage = 'powerupSelect'; renderPage(); };
            const backToMapFromSkinBtn = document.getElementById('back-to-map-from-skin');
            if (backToMapFromSkinBtn) backToMapFromSkinBtn.onclick = () => { currentPage = 'mapSelect'; renderPage(); };


            // Powerup Select Page
            shopItemsData.filter(item => item.type === 'powerup' && (purchasedItems[item.id] || unlockedExclusiveRewards[item.id])).forEach(powerup => {
                const btn = document.getElementById(`powerup-pregame-${powerup.id}`);
                if (btn) btn.onclick = async () => { // Made async
                    const used = await usePowerup(powerup);
                    if (used) {
                        await resetGame(); // Await resetGame
                    }
                };
            });
            const noPowerupBtn = document.getElementById('no-powerup-btn');
            if (noPowerupBtn) noPowerupBtn.onclick = resetGame;
            const startGameAnywayBtn = document.getElementById('start-game-anyway-btn');
            if (startGameAnywayBtn) startGameAnywayBtn.onclick = resetGame;

            const backToSkinFromPowerupBtn = document.getElementById('back-to-skin-from-powerup');
            if (backToSkinFromPowerupBtn) backToSkinFromPowerupBtn.onclick = () => { currentPage = 'skinSelect'; renderPage(); };
            const backToMapFromPowerupBtn = document.getElementById('back-to-map-from-powerup');
            if (backToMapFromPowerupBtn) backToMapFromPowerupBtn.onclick = () => { currentPage = 'mapSelect'; renderPage(); };


            // Game Page (In-game powerup buttons)
            shopItemsData.filter(item => item.type === 'powerup' && (purchasedItems[item.id] || unlockedExclusiveRewards[item.id])).forEach(powerup => {
                const btn = document.getElementById(`powerup-ingame-${powerup.id}`);
                if (btn) btn.onclick = async () => await usePowerup(powerup); // Made async
            });

            // Game Over Page
            const restartGameBtn = document.getElementById('restart-game-btn');
            if (restartGameBtn) restartGameBtn.onclick = resetGame;
            const goToShopFromGameoverBtn = document.getElementById('go-to-shop-from-gameover');
            if (goToShopFromGameoverBtn) goToShopFromGameoverBtn.onclick = () => { currentPage = 'shop'; renderPage(); };
            const backToHomeFromGameoverBtn = document.getElementById('back-to-home-from-gameover');
            if (backToHomeFromGameoverBtn) backToHomeFromGameoverBtn.onclick = () => { currentPage = 'home'; renderPage(); };

            // Shop Page Category Buttons
            const shopCategorySkinsBtn = document.getElementById('shop-category-skins');
            if (shopCategorySkinsBtn) shopCategorySkinsBtn.onclick = () => { shopCategory = 'skins'; renderPage(); };
            const shopCategoryPowerupsBtn = document.getElementById('shop-category-powerups');
            if (shopCategoryPowerupsBtn) shopCategoryPowerupsBtn.onclick = () => { shopCategory = 'powerups'; renderPage(); };
            const shopCategoryDifficultiesBtn = document.getElementById('shop-category-difficulties');
            if (shopCategoryDifficultiesBtn) shopCategoryDifficultiesBtn.onclick = () => { shopCategory = 'difficulties'; renderPage(); };
            const shopCategoryMapsBtn = document.getElementById('shop-category-maps');
            if (shopCategoryMapsBtn) shopCategoryMapsBtn.onclick = () => { shopCategory = 'maps'; renderPage(); };

            // Shop Page Item Buttons
            // Attach event listeners for all shop items (skins, powerups, difficulties, maps)
            const allShopItemIds = shopItemsData.map(item => item.id)
                                .concat(difficulties.map(d => `unlock_${d.id}`))
                                .concat(maps.map(m => `unlock_${m.id}`));

            allShopItemIds.forEach(itemId => {
                const btn = document.getElementById(`shop-item-${itemId}`);
                if (btn) {
                    btn.onclick = async () => { // Made async
                        let itemFound = shopItemsData.find(item => item.id === itemId);
                        if (!itemFound) {
                            itemFound = difficulties.find(d => `unlock_${d.id}` === itemId);
                            if (itemFound) itemFound = { id: `unlock_${itemFound.id}`, name: itemFound.name, price: itemFound.price, type: 'unlock_difficulty' };
                        }
                        if (!itemFound) {
                            itemFound = maps.find(m => `unlock_${m.id}` === itemId);
                            if (itemFound) itemFound = { id: `unlock_${itemFound.id}`, name: itemFound.name, price: itemFound.price, type: 'unlock_map' };
                        }

                        if (itemFound) {
                            // In shop, only allow buying, not activating skins
                            if (itemFound.type === 'skin') {
                                if (!purchasedItems[itemFound.id] && !unlockedExclusiveRewards[itemFound.id]) {
                                    await buyItem(itemFound); // Await buyItem
                                } else {
                                    showMessage('您已拥有有此蛇皮！');
                                }
                            } else {
                                await buyItem(itemFound); // Await buyItem
                            }
                        }
                    };
                }
            });


            // Shop Back to Home Button
            const backToHomeFromShopBtn = document.getElementById('back-to-home-from-shop');
            if (backToHomeFromShopBtn) backToHomeFromShopBtn.onclick = () => { currentPage = 'home'; renderPage(); };

            // Achievements Page Category Buttons
            achievementCategories.forEach(category => {
                const btn = document.getElementById(`achievement-category-${category.id}`);
                if (btn) btn.onclick = () => { achievementCategory = category.id; renderPage(); };
            });

            // Achievements Back to Home Button
            const backToHomeFromAchievementsBtn = document.getElementById('back-to-home-from-achievements');
            if (backToHomeFromAchievementsBtn) backToHomeFromAchievementsBtn.onclick = () => { currentPage = 'home'; renderPage(); };

            // Leaderboard Page
            const backToHomeFromLeaderboardBtn = document.getElementById('back-to-home-from-leaderboard');
            if (backToHomeFromLeaderboardBtn) backToHomeFromLeaderboardBtn.onclick = () => { currentPage = 'home'; renderPage(); };


            // Joystick Event Listeners (only attach if joystick elements exist)
            joystickBase = document.getElementById('joystick-base');
            joystickStick = document.getElementById('joystick-stick');

            if (joystickBase && joystickStick) {
                joystickBase.addEventListener('touchstart', handleJoystickStart);
                joystickBase.addEventListener('touchmove', handleJoystickMove);
                joystickBase.addEventListener('touchend', handleJoystickEnd);
                joystickBase.addEventListener('touchcancel', handleJoystickEnd);
            }
        }

        // Initial setup on window load
        window.onload = async () => {
            // Firebase Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    isGuestUser = false;
                    await loadState();
                    currentPage = 'home'; // Go to home after login/load
                } else {
                    // If no user is logged in, and it's not a guest session
                    if (!isGuestUser) {
                        currentPage = 'auth'; // Show auth page
                    }
                }
                renderPage(); // Render the page based on the current state
            });

            // Handle initial custom token sign-in from Canvas environment
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Error signing in with custom token:", error);
                    showMessage("自动登入失败，请手动登入。");
                    currentPage = 'auth'; // Fallback to auth page
                    renderPage();
                }
            } else if (!auth.currentUser) {
                // If no custom token and no current user, show auth page immediately
                currentPage = 'auth';
                renderPage();
            }
        };

        // Global keyboard listener
        window.addEventListener('keydown', handleKeyDown);

    </script>


</body></html>
